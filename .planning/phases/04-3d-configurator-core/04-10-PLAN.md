---
phase: 04-3d-configurator-core
plan: 10
type: execute
wave: 6
depends_on: ["04-08", "04-09"]
files_modified:
  - src/app/(tabs)/design/page.tsx
  - src/components/configurator/ConfiguratorPage.tsx
autonomous: false

must_haves:
  truths:
    - "Full configurator flow works end-to-end"
    - "All touch gestures functional on mobile"
    - "Performance meets 30+ FPS target"
    - "All 4 wizard steps complete"
  artifacts:
    - path: "src/app/(tabs)/design/page.tsx"
      provides: "Design tab entry point"
      exports: ["default"]
    - path: "src/components/configurator/ConfiguratorPage.tsx"
      provides: "Full configurator assembly"
      exports: ["ConfiguratorPage"]
  key_links:
    - from: "src/app/(tabs)/design/page.tsx"
      to: "src/components/configurator/ConfiguratorPage.tsx"
      via: "component import"
      pattern: "ConfiguratorPage"
---

<objective>
Integrate all configurator components and perform human verification of complete flow.

Purpose: Final assembly and testing of the 3D configurator to ensure all features work together.
Output: Working configurator accessible from Design tab, verified by human testing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-3d-configurator-core/04-CONTEXT.md
All prior 04-* PLAN summaries
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConfiguratorPage integrating all components</name>
  <files>
    src/components/configurator/ConfiguratorPage.tsx
    src/app/(tabs)/design/page.tsx
  </files>
  <action>
Create `src/components/configurator/ConfiguratorPage.tsx`:

Full configurator assembly integrating all components from Plans 01-09.

```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useMutation, useQuery } from 'convex/react'
import { useConvexAuth } from 'convex/react'
import { api } from '../../../convex/_generated/api'
import type { Id } from '../../../convex/_generated/dataModel'

// Stores
import { useCabinetStore } from '@/stores/useCabinetStore'
import { useWizardStore } from '@/stores/useWizardStore'

// Components
import { Canvas3D } from './Canvas3D'
import { CabinetModel } from './CabinetModel'
import { CameraController } from './CameraController'
import { SlotSystem } from './SlotSystem'
import { MaterialApplicator } from './MaterialPreview'
import { WizardShell } from '../wizard/WizardShell'
import { UndoRedoButtons, useUndoRedoKeyboard } from '../wizard/UndoRedoButtons'
import { SaveIndicator } from './SaveIndicator'
import { VersionHistoryButton } from './VersionHistory'
import { useAutoSave } from '@/lib/hooks/useAutoSave'

interface ConfiguratorPageProps {
  designId?: Id<"designs">
  aiEstimate?: { width: number; depth: number; height: number }
}

export function ConfiguratorPage({ designId, aiEstimate }: ConfiguratorPageProps) {
  const router = useRouter()
  const { isAuthenticated, isLoading } = useConvexAuth()

  const [selectedSlot, setSelectedSlot] = useState<{ id: string; type: 'base' | 'overhead' } | null>(null)
  const [currentDesignId, setCurrentDesignId] = useState<Id<"designs"> | null>(designId || null)

  // Auto-save
  const { isSaving, lastSaved } = useAutoSave(currentDesignId)

  // Keyboard shortcuts
  useUndoRedoKeyboard()

  // Create new design if needed
  const createDesign = useMutation(api.designs.create)

  useEffect(() => {
    const initDesign = async () => {
      if (!currentDesignId && isAuthenticated) {
        const id = await createDesign({
          productType: 'kitchen',
          config: {
            dimensions: aiEstimate || { width: 2400, height: 2100, depth: 600 },
            slots: [],
            finishes: { material: null, hardware: null, doorProfile: null },
          },
        })
        setCurrentDesignId(id)
        router.replace(`/design/${id}`)
      }
    }

    if (!isLoading && isAuthenticated && !currentDesignId) {
      initDesign()
    }
  }, [isAuthenticated, isLoading, currentDesignId])

  // Load existing design
  const design = useQuery(
    api.designs.get,
    currentDesignId ? { id: currentDesignId } : 'skip'
  )

  useEffect(() => {
    if (design?.config) {
      useCabinetStore.setState({
        dimensions: design.config.dimensions || { width: 2400, height: 2100, depth: 600 },
        slots: new Map(design.config.slots || []),
        finishes: design.config.finishes || { material: null, hardware: null, doorProfile: null },
      })
    }
  }, [design])

  // Pre-populate with AI estimate
  useEffect(() => {
    if (aiEstimate && !design) {
      useCabinetStore.getState().setDimension('width', aiEstimate.width)
      useCabinetStore.getState().setDimension('height', aiEstimate.height)
      useCabinetStore.getState().setDimension('depth', aiEstimate.depth)
    }
  }, [aiEstimate])

  // Auth check
  if (!isAuthenticated && !isLoading) {
    return (
      <div className="flex flex-col items-center justify-center h-screen p-4">
        <h1 className="text-xl font-semibold mb-2">Sign in to use the configurator</h1>
        <p className="text-zinc-500 mb-4">Your designs will be saved automatically.</p>
        <button
          onClick={() => router.push('/login')}
          className="px-6 py-3 bg-zinc-900 text-white rounded-lg font-medium"
        >
          Sign In
        </button>
      </div>
    )
  }

  const handleSlotTap = (slotId: string) => {
    const type = slotId.startsWith('base') ? 'base' : 'overhead'
    setSelectedSlot({ id: slotId, type })
  }

  return (
    <div className="flex flex-col h-screen bg-zinc-100">
      {/* Header */}
      <div className="flex items-center justify-between px-4 py-2 bg-white border-b">
        <UndoRedoButtons />
        <SaveIndicator isSaving={isSaving} lastSaved={lastSaved} />
        {currentDesignId && <VersionHistoryButton designId={currentDesignId} />}
      </div>

      {/* 3D Viewport - upper 60% per CFG-002 */}
      <div className="h-[60vh] relative bg-zinc-50">
        <Canvas3D className="absolute inset-0">
          <CabinetModel onSlotTap={handleSlotTap} />
          <SlotSystem onSlotTap={handleSlotTap} />
          <CameraController />
          <MaterialApplicator />
        </Canvas3D>
      </div>

      {/* Wizard - lower 40% per CFG-003 */}
      <div className="flex-1 overflow-hidden bg-white">
        <WizardShell
          aiEstimate={aiEstimate}
          selectedSlot={selectedSlot}
          onClosePicker={() => setSelectedSlot(null)}
        />
      </div>
    </div>
  )
}
```

Update `src/app/(tabs)/design/page.tsx`:

```typescript
'use client'

import { Suspense } from 'react'
import dynamic from 'next/dynamic'

// Dynamic import to avoid SSR issues with Three.js
const ConfiguratorPage = dynamic(
  () => import('@/components/configurator/ConfiguratorPage').then(m => ({ default: m.ConfiguratorPage })),
  { ssr: false, loading: () => <ConfiguratorSkeleton /> }
)

function ConfiguratorSkeleton() {
  return (
    <div className="flex flex-col h-screen animate-pulse">
      <div className="h-12 bg-zinc-200" />
      <div className="h-[60vh] bg-zinc-100" />
      <div className="flex-1 bg-zinc-50" />
    </div>
  )
}

export default function DesignPage() {
  // AI estimate could come from photo processing in Phase 03
  // For now, check if there's a pending estimate in session storage
  const aiEstimate = typeof window !== 'undefined'
    ? JSON.parse(sessionStorage.getItem('aiEstimate') || 'null')
    : null

  return (
    <Suspense fallback={<ConfiguratorSkeleton />}>
      <ConfiguratorPage aiEstimate={aiEstimate} />
    </Suspense>
  )
}
```
  </action>
  <verify>
Navigate to Design tab.
Configurator loads with 3D viewport and wizard.
Auth check redirects to login if needed.
All components render without errors.
  </verify>
  <done>
ConfiguratorPage integrates all components. Design tab entry point working.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of complete configurator</name>
  <what-built>
Complete 3D cabinet configurator with:
- 4-step wizard (Dimensions -> Layout -> Finishes -> Review)
- 3D viewport with touch gestures
- Slot-based module placement (12 types)
- Tap-to-toggle cabinet doors
- Undo/redo with 20-state history
- Auto-save to Convex
- Version history with restore
- Shareable design links
- Before/after comparison
- LOD for performance
  </what-built>
  <how-to-verify>
**Pre-requisites:**
- App running at localhost:3000
- Logged in with test account
- Mobile device or Chrome DevTools mobile emulation

**1. Wizard Navigation (CFG-001 -> CFG-005)**
- [ ] Step indicator shows 4 steps at top
- [ ] Progress tracker always visible (sticky)
- [ ] Bottom bar with price always visible (sticky)
- [ ] Next/Back buttons work
- [ ] Validation prevents Next on Step 1 without dimensions
- [ ] Validation prevents Next on Step 2 without modules
- [ ] After visiting Step 3, can go back to Step 1 directly

**2. Step 1: Dimensions (DIM-UI-001 -> DIM-UI-005)**
- [ ] Width slider: 1200-3600mm, 100mm steps
- [ ] Plus/minus steppers work
- [ ] Depth selector: 5 discrete options (400-650mm)
- [ ] Height slider: 1800-2400mm, 100mm steps
- [ ] 3D cabinet updates in real-time as sliders move
- [ ] AI estimate shown if available

**3. Step 2: Layout (SLOT-001 -> SLOT-007)**
- [ ] Slots visible in 3D view (base and overhead)
- [ ] Empty slots show + icon
- [ ] Tap slot opens module picker bottom sheet
- [ ] All 7 base types shown for base slots
- [ ] All 5 overhead types shown for overhead slots
- [ ] Photo/render thumbnails display (placeholders OK)
- [ ] Selecting module places it in slot
- [ ] Interior options sheet available for Standard/DrawerStack
- [ ] Add-ons toggleable (LED, bins)
- [ ] [Apply Changes] in thumb zone

**4. Cabinet Doors (TOUCH-004, CONTEXT.md)**
- [ ] Tap door to toggle open/close
- [ ] Animation smooth (not instant)
- [ ] Multiple doors can be open simultaneously

**5. Touch Gestures (TOUCH-001 -> TOUCH-003)**
- [ ] Single finger drag rotates camera
- [ ] Pinch zooms in/out
- [ ] Two finger drag pans
- [ ] Rotation limited to front hemisphere
- [ ] Reset camera button appears after moving camera
- [ ] Reset returns to 3/4 view

**6. Step 3: Finishes**
- [ ] Material tab shows swatches by category
- [ ] Hardware tab shows options
- [ ] Door Profile tab shows visual selection
- [ ] Selection highlighted
- [ ] 3D viewport updates material in real-time

**7. Step 4: Review (REV-001 -> REV-004)**
- [ ] Dimensions summary displayed
- [ ] Module list displayed
- [ ] Finishes summary displayed
- [ ] Price breakdown visible
- [ ] Variance disclaimer visible

**8. Undo/Redo (CFG-F01)**
- [ ] Undo button visible in header
- [ ] Undo reverts last change
- [ ] Redo restores undone change
- [ ] Ctrl+Z / Ctrl+Shift+Z work
- [ ] History count shown

**9. Auto-Save (CFG-F02)**
- [ ] Save indicator shows "Saving..." briefly after changes
- [ ] Indicator shows "Saved Xs ago"
- [ ] Refresh page - changes persisted
- [ ] Open same design in new tab - same config

**10. Version History (CONTEXT.md)**
- [ ] History button opens version list
- [ ] Versions show timestamp
- [ ] Restore button loads older version
- [ ] New version created after restore

**11. Share (CFG-F03)**
- [ ] Share button available
- [ ] Copy link works
- [ ] Open link in incognito - shows design
- [ ] "Create My Version" works if logged in
- [ ] Original design unchanged

**12. Before/After (CFG-F04)**
- [ ] Available when AI render exists
- [ ] Slider reveals/hides AI render
- [ ] Touch drag works
- [ ] Both views render correctly

**13. Performance (CFG-F05, target devices)**
- [ ] 30+ FPS during normal use
- [ ] No janky animations
- [ ] LOD visible when zooming far out
- [ ] No memory warnings on extended use

**Issues Found:**
[Document any issues here]
  </how-to-verify>
  <resume-signal>
Type "approved" if all checks pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
- All configurator components integrated
- Design tab loads configurator
- Human verification of complete flow
- All requirements met
</verification>

<success_criteria>
- Phase 04 complete with all features working
- 30+ FPS on target devices
- Touch gestures functional
- All 4 wizard steps complete
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/04-3d-configurator-core/04-10-SUMMARY.md`
</output>
