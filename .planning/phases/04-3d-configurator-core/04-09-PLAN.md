---
phase: 04-3d-configurator-core
plan: 09
type: execute
wave: 5
depends_on: ["04-02", "04-07"]
files_modified:
  - src/components/configurator/VersionHistory.tsx
  - src/components/configurator/BeforeAfterSlider.tsx
  - src/components/configurator/LODSystem.tsx
autonomous: true

must_haves:
  truths:
    - "Users can see and restore previous design versions"
    - "Before/after comparison works with AI renders"
    - "LOD system improves performance"
  artifacts:
    - path: "src/components/configurator/VersionHistory.tsx"
      provides: "Version history panel"
      exports: ["VersionHistory"]
    - path: "src/components/configurator/BeforeAfterSlider.tsx"
      provides: "Before/after comparison component"
      exports: ["BeforeAfterSlider"]
    - path: "src/components/configurator/LODSystem.tsx"
      provides: "Level of detail performance helper"
      exports: ["LODWrapper"]
  key_links:
    - from: "src/components/configurator/VersionHistory.tsx"
      to: "convex/designVersions.js"
      via: "useQuery + useMutation"
      pattern: "api\\.designVersions\\."
---

<objective>
Implement version history UI, before/after comparison slider, and LOD performance system.

Purpose: Completes remaining configurator features - version control, visual comparison, and performance optimization.
Output: Version history panel, before/after slider with AI renders, LOD system for 3D performance.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-3d-configurator-core/04-CONTEXT.md
@.planning/phases/04-3d-configurator-core/04-RESEARCH.md
@convex/designVersions.js
@src/lib/hooks/useAutoSave.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VersionHistory panel with restore functionality</name>
  <files>
    src/components/configurator/VersionHistory.tsx
  </files>
  <action>
Create `src/components/configurator/VersionHistory.tsx`:

Per CONTEXT.md: Full version history - users can see and restore previous versions.

Bottom sheet or side panel showing version timeline.

```typescript
import { useState } from 'react'
import Sheet from 'react-modal-sheet'
import { useQuery, useMutation } from 'convex/react'
import { api } from '../../../convex/_generated/api'
import type { Id } from '../../../convex/_generated/dataModel'
import { Button } from '@/components/ui/button'
import { History, RotateCcw, ChevronRight } from 'lucide-react'
import { useCabinetStore } from '@/stores/useCabinetStore'
import { useThree } from '@react-three/fiber'

interface VersionHistoryProps {
  designId: Id<"designs">
  isOpen: boolean
  onClose: () => void
}

export function VersionHistory({ designId, isOpen, onClose }: VersionHistoryProps) {
  const versions = useQuery(api.designVersions.list, { designId, limit: 20 })
  const restoreVersion = useMutation(api.designVersions.restore)
  const [restoringId, setRestoringId] = useState<string | null>(null)

  const { invalidate } = useThree()

  const handleRestore = async (versionId: Id<"designVersions">) => {
    setRestoringId(versionId)

    try {
      const result = await restoreVersion({ designId, versionId })

      // Update local store with restored config
      if (result?.config) {
        useCabinetStore.setState({
          dimensions: result.config.dimensions,
          slots: new Map(result.config.slots || []),
          finishes: result.config.finishes,
        })
        invalidate()
      }

      onClose()
    } catch (error) {
      console.error('Restore failed:', error)
    } finally {
      setRestoringId(null)
    }
  }

  const formatDate = (timestamp: number) => {
    const date = new Date(timestamp)
    return date.toLocaleDateString('en-AU', {
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit',
    })
  }

  return (
    <Sheet
      isOpen={isOpen}
      onClose={onClose}
      snapPoints={[500, 0]}
      initialSnap={0}
    >
      <Sheet.Container>
        <Sheet.Header />
        <Sheet.Content>
          <div className="px-4 pb-8">
            <div className="flex items-center gap-2 mb-4">
              <History className="h-5 w-5 text-zinc-500" />
              <h3 className="text-lg font-semibold">Version History</h3>
            </div>

            {versions === undefined && (
              <div className="animate-pulse space-y-3">
                {[1, 2, 3].map((i) => (
                  <div key={i} className="h-16 bg-zinc-100 rounded-lg" />
                ))}
              </div>
            )}

            {versions?.length === 0 && (
              <div className="text-center py-8 text-zinc-500">
                <p>No versions saved yet.</p>
                <p className="text-sm">Versions are created automatically as you make changes.</p>
              </div>
            )}

            {versions && versions.length > 0 && (
              <div className="space-y-2">
                {versions.map((version, index) => (
                  <div
                    key={version._id}
                    className="flex items-center justify-between p-4 bg-zinc-50 rounded-lg"
                  >
                    <div className="flex-1">
                      <p className="font-medium text-sm">
                        {version.label || `Version ${version.version}`}
                      </p>
                      <p className="text-xs text-zinc-500">
                        {formatDate(version.createdAt)}
                      </p>
                      {/* Config summary */}
                      <p className="text-xs text-zinc-400 mt-1">
                        {version.config?.dimensions?.width}mm x{' '}
                        {version.config?.dimensions?.depth}mm x{' '}
                        {version.config?.dimensions?.height}mm
                      </p>
                    </div>

                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleRestore(version._id)}
                      disabled={restoringId === version._id || index === 0}
                    >
                      {restoringId === version._id ? (
                        'Restoring...'
                      ) : index === 0 ? (
                        'Current'
                      ) : (
                        <>
                          <RotateCcw className="h-4 w-4 mr-1" />
                          Restore
                        </>
                      )}
                    </Button>
                  </div>
                ))}
              </div>
            )}
          </div>
        </Sheet.Content>
      </Sheet.Container>
      <Sheet.Backdrop onTap={onClose} />
    </Sheet>
  )
}

// Button to open version history
export function VersionHistoryButton({ designId }: { designId: Id<"designs"> }) {
  const [isOpen, setIsOpen] = useState(false)

  return (
    <>
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setIsOpen(true)}
        className="text-zinc-500"
      >
        <History className="h-4 w-4 mr-1" />
        History
      </Button>

      <VersionHistory
        designId={designId}
        isOpen={isOpen}
        onClose={() => setIsOpen(false)}
      />
    </>
  )
}
```

Add VersionHistoryButton to design page header.
  </action>
  <verify>
Open version history from design page.
List shows versions with timestamps.
Clicking "Restore" on older version loads that config.
Current version shown but not restorable.
3D view updates after restore.
  </verify>
  <done>
VersionHistory panel with list and restore functionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BeforeAfterSlider for render comparison</name>
  <files>
    src/components/configurator/BeforeAfterSlider.tsx
  </files>
  <action>
Create `src/components/configurator/BeforeAfterSlider.tsx`:

Per requirements CFG-F04: Before/after slider on renders - swipeable comparison view.
Per RESEARCH.md open question: Use split-pane with 3D canvas on one side, AI render image on other.

```typescript
import { useState, useRef } from 'react'
import { motion, PanInfo, useMotionValue, useTransform } from 'framer-motion'
import { Canvas3D } from './Canvas3D'
import { CabinetModel } from './CabinetModel'
import { CameraController } from './CameraController'

interface BeforeAfterSliderProps {
  aiRenderUrl: string // URL of AI-generated render from Phase 03
  className?: string
}

export function BeforeAfterSlider({ aiRenderUrl, className }: BeforeAfterSliderProps) {
  const containerRef = useRef<HTMLDivElement>(null)
  const [sliderPosition, setSliderPosition] = useState(50) // 0-100

  const handleDrag = (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {
    if (!containerRef.current) return

    const container = containerRef.current
    const rect = container.getBoundingClientRect()
    const x = 'touches' in event
      ? (event as TouchEvent).touches[0].clientX
      : (event as MouseEvent).clientX

    const newPosition = ((x - rect.left) / rect.width) * 100
    setSliderPosition(Math.max(0, Math.min(100, newPosition)))
  }

  return (
    <div
      ref={containerRef}
      className={`relative overflow-hidden ${className}`}
      style={{ touchAction: 'none' }}
    >
      {/* Before: AI Render */}
      <div
        className="absolute inset-0"
        style={{ clipPath: `inset(0 ${100 - sliderPosition}% 0 0)` }}
      >
        <img
          src={aiRenderUrl}
          alt="AI Generated Render"
          className="w-full h-full object-cover"
        />
        <div className="absolute top-4 left-4 px-2 py-1 bg-black/50 text-white text-xs rounded">
          AI Render
        </div>
      </div>

      {/* After: 3D Configurator */}
      <div
        className="absolute inset-0"
        style={{ clipPath: `inset(0 0 0 ${sliderPosition}%)` }}
      >
        <Canvas3D className="w-full h-full">
          <CabinetModel />
          <CameraController />
        </Canvas3D>
        <div className="absolute top-4 right-4 px-2 py-1 bg-black/50 text-white text-xs rounded">
          Your Design
        </div>
      </div>

      {/* Slider handle */}
      <motion.div
        className="absolute top-0 bottom-0 w-1 bg-white cursor-ew-resize"
        style={{ left: `${sliderPosition}%`, marginLeft: '-2px' }}
        drag="x"
        dragConstraints={containerRef}
        dragElastic={0}
        dragMomentum={false}
        onDrag={handleDrag}
      >
        {/* Handle grip */}
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white rounded-full shadow-lg flex items-center justify-center">
          <div className="flex gap-0.5">
            <div className="w-0.5 h-4 bg-zinc-300 rounded" />
            <div className="w-0.5 h-4 bg-zinc-300 rounded" />
          </div>
        </div>
      </motion.div>
    </div>
  )
}

// Simplified comparison toggle (alternative to slider)
export function BeforeAfterToggle({ aiRenderUrl, className }: BeforeAfterSliderProps) {
  const [showBefore, setShowBefore] = useState(false)

  return (
    <div className={`relative ${className}`}>
      {showBefore ? (
        <img
          src={aiRenderUrl}
          alt="AI Generated Render"
          className="w-full h-full object-cover"
        />
      ) : (
        <Canvas3D className="w-full h-full">
          <CabinetModel />
          <CameraController />
        </Canvas3D>
      )}

      {/* Toggle button */}
      <button
        onClick={() => setShowBefore(!showBefore)}
        className="absolute bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-black/70 text-white text-sm rounded-full"
      >
        {showBefore ? 'Show Design' : 'Show AI Render'}
      </button>
    </div>
  )
}
```

Integrate BeforeAfterSlider into Review step when AI render is available.
  </action>
  <verify>
Show BeforeAfterSlider with AI render URL.
Drag slider to reveal/hide AI render vs 3D design.
Handle is touch-friendly.
Both views render correctly.
  </verify>
  <done>
BeforeAfterSlider with swipeable comparison between AI render and 3D design.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create LODSystem for performance optimization</name>
  <files>
    src/components/configurator/LODSystem.tsx
  </files>
  <action>
Create `src/components/configurator/LODSystem.tsx`:

Per requirements CFG-F05: LOD system for performance - geometry simplifies when zoomed out.
Per RESEARCH.md: Use `<Detailed>` component from drei with distance thresholds.

```typescript
import { ReactNode, useMemo } from 'react'
import { Detailed, useGLTF } from '@react-three/drei'
import * as THREE from 'three'

// Default LOD distances (tune based on device testing per RESEARCH.md)
const DEFAULT_DISTANCES = [0, 3, 8] // Near, mid, far

interface LODWrapperProps {
  children: [ReactNode, ReactNode, ReactNode] // High, medium, low detail
  distances?: [number, number, number]
}

/**
 * Wrapper component that swaps detail levels based on camera distance.
 * Pass 3 children: [high detail, medium detail, low detail]
 */
export function LODWrapper({
  children,
  distances = DEFAULT_DISTANCES,
}: LODWrapperProps) {
  return (
    <Detailed distances={distances}>
      {children}
    </Detailed>
  )
}

/**
 * Simple box LOD - high detail mesh, medium simplified, low box proxy
 */
interface SimpleLODProps {
  highDetail: ReactNode
  position?: [number, number, number]
  size?: [number, number, number] // For low-detail box
}

export function SimpleLOD({
  highDetail,
  position = [0, 0, 0],
  size = [1, 1, 1],
}: SimpleLODProps) {
  // Medium detail: same geometry, simpler material
  const mediumMaterial = useMemo(
    () => new THREE.MeshBasicMaterial({ color: '#a1a1aa' }),
    []
  )

  // Low detail: box proxy
  const lowMaterial = useMemo(
    () => new THREE.MeshBasicMaterial({ color: '#d4d4d8', wireframe: true }),
    []
  )

  return (
    <group position={position}>
      <Detailed distances={DEFAULT_DISTANCES}>
        {/* High detail */}
        {highDetail}

        {/* Medium detail - simplified */}
        <mesh>
          <boxGeometry args={size} />
          <primitive object={mediumMaterial} attach="material" />
        </mesh>

        {/* Low detail - wireframe box */}
        <mesh>
          <boxGeometry args={size} />
          <primitive object={lowMaterial} attach="material" />
        </mesh>
      </Detailed>
    </group>
  )
}

/**
 * Hook to get LOD config based on device performance
 */
export function useLODConfig() {
  // Could be enhanced to detect device capabilities
  const isLowEndDevice = useMemo(() => {
    // Simple heuristic: check device memory if available
    const nav = navigator as any
    return nav.deviceMemory ? nav.deviceMemory < 4 : false
  }, [])

  return {
    distances: isLowEndDevice ? [0, 2, 5] : DEFAULT_DISTANCES,
    enableLOD: true,
  }
}

/**
 * Performance monitor wrapper that logs FPS
 */
import { useFrame } from '@react-three/fiber'
import { useRef } from 'react'

export function FPSMonitor({ onFPSDrop }: { onFPSDrop?: () => void }) {
  const frameCount = useRef(0)
  const lastTime = useRef(performance.now())

  useFrame(() => {
    frameCount.current++
    const now = performance.now()

    if (now - lastTime.current >= 1000) {
      const fps = frameCount.current
      frameCount.current = 0
      lastTime.current = now

      // Alert if FPS drops below threshold
      if (fps < 25 && onFPSDrop) {
        onFPSDrop()
      }
    }
  })

  return null
}
```

Apply LODWrapper to complex module components (DrawerStack, PullOutPantry).
  </action>
  <verify>
Zoom camera in/out.
At close distance: full detail visible.
At medium distance: simplified geometry.
At far distance: wireframe/box proxy.
FPS stays above 30 on target devices.
  </verify>
  <done>
LODSystem with Detailed wrapper and performance utilities.
  </done>
</task>

</tasks>

<verification>
- Version history shows list of saved versions
- Restore button loads selected version config
- Before/after slider works with touch drag
- AI render and 3D design both visible in comparison
- LOD switches detail levels based on camera distance
- Performance maintained at 30+ FPS
</verification>

<success_criteria>
- Version history fully functional with restore
- Before/after comparison working
- LOD system implemented
- All configurator features complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-3d-configurator-core/04-09-SUMMARY.md`
</output>
