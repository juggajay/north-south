---
phase: 04-3d-configurator-core
plan: 08
type: execute
wave: 4
depends_on: ["04-02", "04-06"]
files_modified:
  - src/components/wizard/UndoRedoButtons.tsx
  - src/components/configurator/SaveIndicator.tsx
  - src/app/(tabs)/design/[id]/page.tsx
  - src/app/design/share/[id]/page.tsx
  - convex/designs.js
autonomous: true

must_haves:
  truths:
    - "Undo button visible and functional"
    - "Design auto-saves on every change"
    - "Share link opens saved design"
  artifacts:
    - path: "src/components/wizard/UndoRedoButtons.tsx"
      provides: "Undo/redo UI controls"
      exports: ["UndoRedoButtons"]
    - path: "src/components/configurator/SaveIndicator.tsx"
      provides: "Save status display"
      exports: ["SaveIndicator"]
    - path: "src/app/(tabs)/design/[id]/page.tsx"
      provides: "Design edit page with configurator"
      exports: ["default"]
    - path: "src/app/design/share/[id]/page.tsx"
      provides: "Shared design view page"
      exports: ["default"]
  key_links:
    - from: "src/components/wizard/UndoRedoButtons.tsx"
      to: "src/stores/useHistoryStore.ts"
      via: "undo/redo actions"
      pattern: "undo\\(\\)|redo\\(\\)"
    - from: "src/app/design/share/[id]/page.tsx"
      to: "convex/designs.js"
      via: "useQuery(api.designs.get)"
      pattern: "api\\.designs\\.get"
    - from: "src/app/(tabs)/design/[id]/page.tsx"
      to: "convex/designs.js"
      via: "useMutation(api.designs.update)"
      pattern: "api\\.designs\\.(create|update)"
---

<objective>
Implement undo/redo UI, auto-save integration, and shareable design links.

Purpose: Completes the user experience features - users never lose work and can share designs.
Output: Undo/redo buttons, save indicator, design page with auto-save, share page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-3d-configurator-core/04-CONTEXT.md
@src/stores/useHistoryStore.ts
@src/lib/hooks/useAutoSave.ts
@convex/designs.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UndoRedoButtons with visible undo button</name>
  <files>
    src/components/wizard/UndoRedoButtons.tsx
  </files>
  <action>
Create `src/components/wizard/UndoRedoButtons.tsx`:

Per requirements CFG-F01: Undo/redo history (20 states), visible undo button.
Per RESEARCH.md: Zustand temporal middleware provides undo/redo.

**NOTE:** This component does NOT use useThree() - it's used outside Canvas context.
Store changes trigger 3D updates via DimensionSync (from Plan 04) which is inside Canvas.

```typescript
import { useEffect } from 'react'
import { Button } from '@/components/ui/button'
import { Undo2, Redo2 } from 'lucide-react'
import { useCabinetStore } from '@/stores/useCabinetStore'

export function UndoRedoButtons() {
  // Access temporal middleware state
  const { undo, redo, pastStates, futureStates } = useCabinetStore.temporal.getState()

  const canUndo = pastStates.length > 0
  const canRedo = futureStates.length > 0

  // No useThree() here - DimensionSync inside Canvas handles 3D invalidation
  // when store changes from undo/redo

  return (
    <div className="flex items-center gap-2">
      <Button
        variant="outline"
        size="icon"
        onClick={undo}
        disabled={!canUndo}
        className="h-10 w-10"
        title="Undo (Ctrl+Z)"
      >
        <Undo2 className="h-4 w-4" />
      </Button>

      <Button
        variant="outline"
        size="icon"
        onClick={redo}
        disabled={!canRedo}
        className="h-10 w-10"
        title="Redo (Ctrl+Shift+Z)"
      >
        <Redo2 className="h-4 w-4" />
      </Button>

      {/* History count indicator */}
      {pastStates.length > 0 && (
        <span className="text-xs text-zinc-500">
          {pastStates.length} change{pastStates.length !== 1 ? 's' : ''}
        </span>
      )}
    </div>
  )
}

// Keyboard shortcut hook - use in ConfiguratorPage
export function useUndoRedoKeyboard() {
  const { undo, redo } = useCabinetStore.temporal.getState()

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'z') {
        if (e.shiftKey) {
          redo()
        } else {
          undo()
        }
        e.preventDefault()
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [undo, redo])
}
```

Note: Shake-to-undo deferred per RESEARCH.md open questions (unclear browser support).

Place UndoRedoButtons in WizardShell header area.
  </action>
  <verify>
UndoRedoButtons visible in configurator.
Make a change (e.g., dimension), undo reverts it.
Redo restores the change.
Button disabled states work correctly.
Keyboard shortcuts work (Ctrl+Z, Ctrl+Shift+Z).
  </verify>
  <done>
UndoRedoButtons with visible undo button and keyboard shortcuts working.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SaveIndicator and design page with auto-save</name>
  <files>
    src/components/configurator/SaveIndicator.tsx
    src/app/(tabs)/design/[id]/page.tsx
  </files>
  <action>
Create `src/components/configurator/SaveIndicator.tsx`:

Per CONTEXT.md: Auto-save continuously (every change syncs automatically).
Show subtle "Saving..." / "Saved" indicator.

```typescript
import { Cloud, CloudOff, Loader2, Check } from 'lucide-react'

interface SaveIndicatorProps {
  isSaving: boolean
  lastSaved: Date | null
  isOnline?: boolean
}

export function SaveIndicator({ isSaving, lastSaved, isOnline = true }: SaveIndicatorProps) {
  if (!isOnline) {
    return (
      <div className="flex items-center gap-1.5 text-amber-600">
        <CloudOff className="h-4 w-4" />
        <span className="text-xs">Offline</span>
      </div>
    )
  }

  if (isSaving) {
    return (
      <div className="flex items-center gap-1.5 text-zinc-500">
        <Loader2 className="h-4 w-4 animate-spin" />
        <span className="text-xs">Saving...</span>
      </div>
    )
  }

  if (lastSaved) {
    const timeAgo = formatTimeAgo(lastSaved)
    return (
      <div className="flex items-center gap-1.5 text-zinc-400">
        <Check className="h-4 w-4" />
        <span className="text-xs">Saved {timeAgo}</span>
      </div>
    )
  }

  return null
}

function formatTimeAgo(date: Date): string {
  const seconds = Math.floor((new Date().getTime() - date.getTime()) / 1000)

  if (seconds < 10) return 'just now'
  if (seconds < 60) return `${seconds}s ago`
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`
  return `${Math.floor(seconds / 3600)}h ago`
}
```

Create `src/app/(tabs)/design/[id]/page.tsx`:

Design edit page that loads an existing design and enables configurator with auto-save.

**NOTE:** Uses existing `api.designs.create` and `api.designs.update` mutations from convex/designs.js
(created in Phase 01 foundation). These mutations already exist and handle:
- `create`: Creates new design with productType and config
- `update`: Updates design config by ID
- `get`: Fetches design by ID

```typescript
'use client'

import { useParams, useRouter } from 'next/navigation'
import { useQuery, useMutation } from 'convex/react'
import { api } from '../../../../../convex/_generated/api'
import type { Id } from '../../../../../convex/_generated/dataModel'
import { useEffect } from 'react'
import { useCabinetStore } from '@/stores/useCabinetStore'
import { useAutoSave } from '@/lib/hooks/useAutoSave'
import { Canvas3D } from '@/components/configurator/Canvas3D'
import { CabinetModel } from '@/components/configurator/CabinetModel'
import { CameraController } from '@/components/configurator/CameraController'
import { DimensionSync } from '@/components/wizard/DimensionSync'
import { WizardShell } from '@/components/wizard/WizardShell'
import { SaveIndicator } from '@/components/configurator/SaveIndicator'
import { Skeleton } from '@/components/ui/skeleton'

export default function DesignPage() {
  const params = useParams()
  const router = useRouter()
  const designId = params.id as Id<"designs">

  // Fetch design using existing api.designs.get (from Phase 01)
  const design = useQuery(api.designs.get, { id: designId })

  // Auto-save hook (uses api.designs.update from Phase 01)
  const { isSaving, lastSaved } = useAutoSave(designId)

  // Load config into store when design loads
  useEffect(() => {
    if (design?.config) {
      // Hydrate store from saved config
      useCabinetStore.setState({
        dimensions: design.config.dimensions || { width: 2400, height: 2100, depth: 600 },
        slots: new Map(design.config.slots || []),
        finishes: design.config.finishes || { material: null, hardware: null, doorProfile: null },
      })
    }
  }, [design])

  if (design === undefined) {
    // Loading
    return (
      <div className="flex flex-col h-screen">
        <Skeleton className="h-12" />
        <Skeleton className="flex-1" />
        <Skeleton className="h-[40vh]" />
      </div>
    )
  }

  if (design === null) {
    // Not found
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="text-center">
          <h1 className="text-xl font-semibold mb-2">Design not found</h1>
          <button
            onClick={() => router.push('/design')}
            className="text-sm text-zinc-500 underline"
          >
            Go back
          </button>
        </div>
      </div>
    )
  }

  return (
    <div className="flex flex-col h-screen">
      {/* Header with save indicator */}
      <div className="flex items-center justify-between px-4 py-2 border-b bg-white">
        <button onClick={() => router.back()} className="text-sm text-zinc-600">
          ← Back
        </button>
        <SaveIndicator isSaving={isSaving} lastSaved={lastSaved} />
      </div>

      {/* 3D Viewport - upper 60% */}
      <div className="h-[60vh] relative">
        <Canvas3D className="absolute inset-0">
          <DimensionSync />
          <CabinetModel />
          <CameraController />
        </Canvas3D>
      </div>

      {/* Wizard - lower 40% */}
      <div className="flex-1 overflow-hidden">
        <WizardShell />
      </div>
    </div>
  )
}
```

Also create a "new design" flow that creates a design then redirects to /design/[id].
  </action>
  <verify>
Navigate to /design/[existingId] - loads saved configuration.
Make changes - SaveIndicator shows "Saving..." then "Saved".
Refresh page - changes persisted.
Navigate to /design/[nonexistent] - shows not found.
  </verify>
  <done>
Design page with auto-save and loading from Convex working. Uses existing designs.create/update mutations from Phase 01.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create shareable design page with deep link and duplicate mutation</name>
  <files>
    src/app/design/share/[id]/page.tsx
    convex/designs.js
  </files>
  <action>
Create `src/app/design/share/[id]/page.tsx`:

Per CONTEXT.md: Shared link behavior is Claude's discretion.
Recommendation per RESEARCH.md: Auto-duplicate on open if not owner.

Share page is view-only for non-owners, or redirects to edit for owner.

```typescript
'use client'

import { useParams, useRouter } from 'next/navigation'
import { useQuery, useMutation } from 'convex/react'
import { useConvexAuth } from 'convex/react'
import { api } from '../../../../../convex/_generated/api'
import type { Id } from '../../../../../convex/_generated/dataModel'
import { useEffect, useState } from 'react'
import { useCabinetStore } from '@/stores/useCabinetStore'
import { Canvas3D } from '@/components/configurator/Canvas3D'
import { CabinetModel } from '@/components/configurator/CabinetModel'
import { CameraController } from '@/components/configurator/CameraController'
import { DimensionSync } from '@/components/wizard/DimensionSync'
import { Button } from '@/components/ui/button'
import { Copy, Check } from 'lucide-react'

export default function SharePage() {
  const params = useParams()
  const router = useRouter()
  const designId = params.id as Id<"designs">

  const { isAuthenticated, isLoading: authLoading } = useConvexAuth()
  const design = useQuery(api.designs.get, { id: designId })
  const duplicateDesign = useMutation(api.designs.duplicate)

  const [copied, setCopied] = useState(false)

  // Load design config into store for 3D preview
  useEffect(() => {
    if (design?.config) {
      useCabinetStore.setState({
        dimensions: design.config.dimensions,
        slots: new Map(design.config.slots || []),
        finishes: design.config.finishes,
      })
    }
  }, [design])

  const handleCopyLink = () => {
    navigator.clipboard.writeText(window.location.href)
    setCopied(true)
    setTimeout(() => setCopied(false), 2000)
  }

  const handleDuplicate = async () => {
    if (!design) return

    try {
      const newDesignId = await duplicateDesign({
        sourceId: designId,
      })
      router.push(`/design/${newDesignId}`)
    } catch (error) {
      console.error('Failed to duplicate:', error)
    }
  }

  if (design === undefined || authLoading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="animate-pulse text-zinc-500">Loading design...</div>
      </div>
    )
  }

  if (design === null) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="text-center">
          <h1 className="text-xl font-semibold mb-2">Design not found</h1>
          <p className="text-zinc-500 mb-4">This design may have been deleted.</p>
          <Button onClick={() => router.push('/')}>Go Home</Button>
        </div>
      </div>
    )
  }

  return (
    <div className="flex flex-col h-screen bg-zinc-50">
      {/* Header */}
      <div className="flex items-center justify-between px-4 py-3 bg-white border-b">
        <div>
          <h1 className="font-semibold">Shared Design</h1>
          <p className="text-xs text-zinc-500">View-only</p>
        </div>
        <Button
          variant="outline"
          size="sm"
          onClick={handleCopyLink}
        >
          {copied ? (
            <>
              <Check className="h-4 w-4 mr-1" />
              Copied!
            </>
          ) : (
            <>
              <Copy className="h-4 w-4 mr-1" />
              Copy Link
            </>
          )}
        </Button>
      </div>

      {/* 3D Preview */}
      <div className="flex-1 relative">
        <Canvas3D className="absolute inset-0">
          <DimensionSync />
          <CabinetModel />
          <CameraController />
        </Canvas3D>
      </div>

      {/* Design summary */}
      <div className="p-4 bg-white border-t">
        <div className="grid grid-cols-3 gap-4 text-sm mb-4">
          <div>
            <span className="text-zinc-500">Width</span>
            <p className="font-semibold">{design.config?.dimensions?.width || '—'}mm</p>
          </div>
          <div>
            <span className="text-zinc-500">Depth</span>
            <p className="font-semibold">{design.config?.dimensions?.depth || '—'}mm</p>
          </div>
          <div>
            <span className="text-zinc-500">Height</span>
            <p className="font-semibold">{design.config?.dimensions?.height || '—'}mm</p>
          </div>
        </div>

        {/* CTA */}
        {isAuthenticated ? (
          <Button onClick={handleDuplicate} className="w-full">
            Create My Version
          </Button>
        ) : (
          <Button onClick={() => router.push('/login')} className="w-full">
            Sign In to Create Your Own
          </Button>
        )}
      </div>
    </div>
  )
}
```

Add duplicate mutation to convex/designs.js:

**NOTE:** The file already has `create`, `update`, `get`, etc. mutations from Phase 01.
Only ADD the new `duplicate` mutation - do not remove existing code.

```javascript
// ADD this new mutation to the existing convex/designs.js file:

/**
 * Duplicate an existing design (for share flow)
 */
export const duplicate = mutation({
  args: {
    sourceId: v.id("designs"),
  },
  handler: async (ctx, { sourceId }) => {
    const source = await ctx.db.get(sourceId);
    if (!source) throw new Error("Design not found");

    const identity = await ctx.auth.getUserIdentity();
    const now = Date.now();

    return await ctx.db.insert("designs", {
      userId: identity?.subject ? identity.subject as Id<"users"> : null,
      productType: source.productType,
      config: source.config,
      status: "draft",
      renders: [],
      createdAt: now,
      updatedAt: now,
    });
  },
});
```
  </action>
  <verify>
Navigate to /design/share/[id] - shows 3D preview of design.
"Copy Link" button copies URL to clipboard.
"Create My Version" (if logged in) creates duplicate and redirects.
Non-logged in users see "Sign In" CTA.
3D viewport is interactive (rotate, zoom).
  </verify>
  <done>
Shareable design page with deep link, preview, and duplicate functionality. Added duplicate mutation to existing convex/designs.js.
  </done>
</task>

</tasks>

<verification>
- Undo button visible in configurator UI
- Undo reverts last change, redo restores it
- Keyboard shortcuts work (Ctrl+Z, Ctrl+Shift+Z)
- SaveIndicator shows saving/saved status
- Design page loads saved config from Convex (uses existing api.designs.get)
- Changes auto-save (uses existing api.designs.update)
- Share page shows 3D preview
- Share link can be copied
- Authenticated users can duplicate shared designs (new api.designs.duplicate)
</verification>

<success_criteria>
- Undo/redo working with 20-state history
- Auto-save functional with status indicator
- Share links work and allow duplicating
- Full design persistence across sessions
</success_criteria>

<output>
After completion, create `.planning/phases/04-3d-configurator-core/04-08-SUMMARY.md`
</output>
