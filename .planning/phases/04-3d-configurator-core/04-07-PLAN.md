---
phase: 04-3d-configurator-core
plan: 07
type: execute
wave: 4
depends_on: ["04-05", "04-06"]
files_modified:
  - src/components/wizard/StepFinishes.tsx
  - src/components/wizard/StepReview.tsx
  - src/components/wizard/MaterialPicker.tsx
  - src/components/configurator/MaterialPreview.tsx
autonomous: true

must_haves:
  truths:
    - "Step 3 shows material/hardware/profile selection"
    - "3D viewport updates materials in real-time"
    - "Step 4 shows complete configuration summary"
  artifacts:
    - path: "src/components/wizard/StepFinishes.tsx"
      provides: "Step 3 finish selection controls"
      exports: ["StepFinishes"]
    - path: "src/components/wizard/StepReview.tsx"
      provides: "Step 4 review and summary"
      exports: ["StepReview"]
    - path: "src/components/wizard/MaterialPicker.tsx"
      provides: "Material swatch selection UI"
      exports: ["MaterialPicker"]
    - path: "src/components/configurator/MaterialPreview.tsx"
      provides: "Real-time material application to 3D"
      exports: ["useMaterialPreview"]
  key_links:
    - from: "src/components/wizard/StepFinishes.tsx"
      to: "src/stores/useCabinetStore.ts"
      via: "setFinish action"
      pattern: "setFinish\\("
    - from: "src/components/configurator/MaterialPreview.tsx"
      to: "src/stores/useCabinetStore.ts"
      via: "finishes state"
      pattern: "finishes"
---

<objective>
Create Step 3 (Finishes) with material selection and Step 4 (Review) with configuration summary.

Purpose: Completes the 4-step wizard with finish selection and review before submission.
Output: Material picker with swatches, real-time 3D material updates, review summary component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-3d-configurator-core/04-CONTEXT.md
@convex/schema.js
@src/stores/useCabinetStore.ts
@src/components/wizard/WizardShell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MaterialPicker with swatches and categories</name>
  <files>
    src/components/wizard/MaterialPicker.tsx
  </files>
  <action>
Create `src/components/wizard/MaterialPicker.tsx`:

Swipeable cards per requirement FIN-001 -> FIN-005:
- Material: Polytec finishes grouped by category (woodmatt, satin, gloss)
- Hardware: Blum options (hinges, drawer systems)
- Door Profile: Visual selection (flat panel, shaker, etc.)

```typescript
import { useState } from 'react'
import { useCabinetStore } from '@/stores/useCabinetStore'
import { useQuery } from 'convex/react'
import { api } from '../../../convex/_generated/api'
import { cn } from '@/lib/utils'
import { motion, AnimatePresence } from 'framer-motion'

type FinishCategory = 'material' | 'hardware' | 'doorProfile'

const CATEGORIES: { id: FinishCategory; label: string }[] = [
  { id: 'material', label: 'Material' },
  { id: 'hardware', label: 'Hardware' },
  { id: 'doorProfile', label: 'Door Profile' },
]

export function MaterialPicker() {
  const [activeCategory, setActiveCategory] = useState<FinishCategory>('material')
  const finishes = useCabinetStore((state) => state.finishes)
  const setFinish = useCabinetStore((state) => state.setFinish)

  // Fetch materials from Convex
  const materials = useQuery(api.products.materials.list) || []
  const hardware = useQuery(api.products.hardware.list) || []
  const doorProfiles = useQuery(api.doorProfiles.list) || []

  const handleMaterialSelect = (code: string) => {
    setFinish('material', code)
  }

  const handleHardwareSelect = (code: string) => {
    setFinish('hardware', code)
  }

  const handleProfileSelect = (code: string) => {
    setFinish('doorProfile', code)
  }

  return (
    <div className="space-y-4">
      {/* Category tabs */}
      <div className="flex border-b">
        {CATEGORIES.map((cat) => (
          <button
            key={cat.id}
            onClick={() => setActiveCategory(cat.id)}
            className={cn(
              "flex-1 py-3 text-sm font-medium border-b-2 -mb-px",
              activeCategory === cat.id
                ? "border-zinc-900 text-zinc-900"
                : "border-transparent text-zinc-500"
            )}
          >
            {cat.label}
          </button>
        ))}
      </div>

      {/* Content area with swipe animation */}
      <AnimatePresence mode="wait">
        <motion.div
          key={activeCategory}
          initial={{ opacity: 0, x: 20 }}
          animate={{ opacity: 1, x: 0 }}
          exit={{ opacity: 0, x: -20 }}
          transition={{ duration: 0.2 }}
          className="min-h-[300px]"
        >
          {activeCategory === 'material' && (
            <MaterialSwatches
              materials={materials}
              selected={finishes.material}
              onSelect={handleMaterialSelect}
            />
          )}

          {activeCategory === 'hardware' && (
            <HardwareOptions
              hardware={hardware}
              selected={finishes.hardware}
              onSelect={handleHardwareSelect}
            />
          )}

          {activeCategory === 'doorProfile' && (
            <DoorProfiles
              profiles={doorProfiles}
              selected={finishes.doorProfile}
              onSelect={handleProfileSelect}
            />
          )}
        </motion.div>
      </AnimatePresence>
    </div>
  )
}

// Material swatches grid
function MaterialSwatches({ materials, selected, onSelect }: any) {
  // Group by category
  const grouped = materials.reduce((acc: any, mat: any) => {
    const category = mat.category || 'other'
    if (!acc[category]) acc[category] = []
    acc[category].push(mat)
    return acc
  }, {})

  return (
    <div className="space-y-6">
      {Object.entries(grouped).map(([category, items]: any) => (
        <div key={category}>
          <h4 className="text-sm font-medium text-zinc-700 mb-2 capitalize">
            {category}
          </h4>
          <div className="grid grid-cols-4 gap-2">
            {items.map((mat: any) => (
              <button
                key={mat.code}
                onClick={() => onSelect(mat.code)}
                className={cn(
                  "aspect-square rounded-lg border-2 overflow-hidden",
                  selected === mat.code
                    ? "border-zinc-900 ring-2 ring-zinc-900 ring-offset-2"
                    : "border-zinc-200"
                )}
              >
                {mat.swatchUrl ? (
                  <img
                    src={mat.swatchUrl}
                    alt={mat.name}
                    className="w-full h-full object-cover"
                  />
                ) : (
                  <div
                    className="w-full h-full"
                    style={{ backgroundColor: mat.colorHex || '#d4d4d4' }}
                  />
                )}
              </button>
            ))}
          </div>
        </div>
      ))}
    </div>
  )
}

// Hardware options list
function HardwareOptions({ hardware, selected, onSelect }: any) {
  return (
    <div className="space-y-2">
      {hardware.map((item: any) => (
        <button
          key={item.code}
          onClick={() => onSelect(item.code)}
          className={cn(
            "w-full p-4 border rounded-lg text-left",
            selected === item.code
              ? "border-zinc-900 bg-zinc-50"
              : "border-zinc-200"
          )}
        >
          <p className="font-medium">{item.name}</p>
          <p className="text-sm text-zinc-500">{item.supplier}</p>
        </button>
      ))}
    </div>
  )
}

// Door profile selection
function DoorProfiles({ profiles, selected, onSelect }: any) {
  return (
    <div className="grid grid-cols-2 gap-3">
      {profiles.map((profile: any) => (
        <button
          key={profile.code}
          onClick={() => onSelect(profile.code)}
          className={cn(
            "p-4 border rounded-lg text-center",
            selected === profile.code
              ? "border-zinc-900 bg-zinc-50"
              : "border-zinc-200"
          )}
        >
          {profile.imageUrl && (
            <img
              src={profile.imageUrl}
              alt={profile.name}
              className="w-full h-20 object-contain mb-2"
            />
          )}
          <p className="font-medium text-sm">{profile.name}</p>
        </button>
      ))}
    </div>
  )
}
```
  </action>
  <verify>
Render MaterialPicker in isolation.
Category tabs switch content.
Selecting material updates store.
Selected item shows visual highlight.
Materials load from Convex (or show empty if seed data missing).
  </verify>
  <done>
MaterialPicker with categorized selection UI complete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MaterialPreview hook for real-time 3D updates</name>
  <files>
    src/components/configurator/MaterialPreview.tsx
  </files>
  <action>
Create `src/components/configurator/MaterialPreview.tsx`:

This hook/component applies selected materials to 3D cabinet in real-time.

Per RESEARCH.md: Share materials with useMemo, don't create new materials per mesh.

```typescript
import { useMemo, useEffect } from 'react'
import * as THREE from 'three'
import { useThree } from '@react-three/fiber'
import { useCabinetStore } from '@/stores/useCabinetStore'
import { useQuery } from 'convex/react'
import { api } from '../../../convex/_generated/api'

// Color mapping for Polytec codes (fallback if no texture)
const MATERIAL_COLORS: Record<string, string> = {
  'POL-NOWM': '#c4a77d', // Natural Oak Woodmatt
  'POL-RIWM': '#e8dcc8', // Riverine Woodmatt
  'POL-BWWM': '#f5e6d3', // Baltic Wood Woodmatt
  'POL-MWS': '#f5f5f5',  // Milano White Satin
  'POL-SBS': '#1a1a1a',  // Shark Black Satin
  // Add more as needed
}

export function useMaterialPreview() {
  const finishes = useCabinetStore((state) => state.finishes)
  const { invalidate } = useThree()

  // Fetch material details
  const materialData = useQuery(
    api.products.materials.getByCode,
    finishes.material ? { code: finishes.material } : 'skip'
  )

  // Create shared material instance
  const cabinetMaterial = useMemo(() => {
    const color = finishes.material
      ? MATERIAL_COLORS[finishes.material] || '#d4d4d4'
      : '#d4d4d4'

    return new THREE.MeshStandardMaterial({
      color,
      roughness: 0.5,
      metalness: 0.1,
      // If texture URL available, load it
      // map: textureLoader.load(materialData?.textureUrl)
    })
  }, [finishes.material])

  // Invalidate on material change
  useEffect(() => {
    invalidate()
  }, [finishes.material, invalidate])

  return {
    cabinetMaterial,
    doorMaterial: cabinetMaterial, // Same for now, could differentiate
    currentMaterial: finishes.material,
    currentHardware: finishes.hardware,
    currentProfile: finishes.doorProfile,
  }
}

// Component to apply materials to all cabinet meshes
export function MaterialApplicator() {
  const { cabinetMaterial } = useMaterialPreview()
  const { scene } = useThree()

  useEffect(() => {
    // Traverse scene and update materials
    scene.traverse((object) => {
      if (object instanceof THREE.Mesh) {
        // Only apply to cabinet parts (check name or userData)
        if (object.name.includes('cabinet') || object.userData.isCabinet) {
          object.material = cabinetMaterial
        }
      }
    })
  }, [cabinetMaterial, scene])

  return null
}
```

Update CabinetFrame and module components to use shared material from useMaterialPreview.
  </action>
  <verify>
Change material in MaterialPicker.
3D viewport updates cabinet color in real-time.
No performance issues (material shared, not recreated).
  </verify>
  <done>
Real-time material preview working with shared material instances.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create StepFinishes and StepReview components</name>
  <files>
    src/components/wizard/StepFinishes.tsx
    src/components/wizard/StepReview.tsx
  </files>
  <action>
Create `src/components/wizard/StepFinishes.tsx`:

```typescript
import { MaterialPicker } from './MaterialPicker'
import { useCabinetStore } from '@/stores/useCabinetStore'

export function StepFinishes() {
  const finishes = useCabinetStore((state) => state.finishes)

  return (
    <div className="p-4">
      <div className="mb-4">
        <h2 className="text-lg font-semibold text-zinc-900">Select Finishes</h2>
        <p className="text-sm text-zinc-500">
          Choose materials, hardware, and door profile for your cabinet.
        </p>
      </div>

      <MaterialPicker />

      {/* Summary of selections */}
      <div className="mt-6 p-4 bg-zinc-100 rounded-lg space-y-2">
        <div className="flex justify-between text-sm">
          <span className="text-zinc-600">Material</span>
          <span className="font-medium">{finishes.material || 'Not selected'}</span>
        </div>
        <div className="flex justify-between text-sm">
          <span className="text-zinc-600">Hardware</span>
          <span className="font-medium">{finishes.hardware || 'Not selected'}</span>
        </div>
        <div className="flex justify-between text-sm">
          <span className="text-zinc-600">Door Profile</span>
          <span className="font-medium">{finishes.doorProfile || 'Not selected'}</span>
        </div>
      </div>
    </div>
  )
}
```

Create `src/components/wizard/StepReview.tsx`:

Per requirements REV-001 -> REV-004: Review screen with price breakdown.

```typescript
import { useCabinetStore } from '@/stores/useCabinetStore'
import { useWizardStore } from '@/stores/useWizardStore'
import { Button } from '@/components/ui/button'

export function StepReview() {
  const dimensions = useCabinetStore((state) => state.dimensions)
  const slots = useCabinetStore((state) => state.slots)
  const finishes = useCabinetStore((state) => state.finishes)

  // Calculate price (placeholder - real pricing in Phase 05)
  const moduleCount = slots.size
  const basePrice = 5000
  const modulePrice = moduleCount * 800
  const estimatedTotal = basePrice + modulePrice

  const handleSubmit = () => {
    // Will be implemented in Phase 06 (Quote Submission)
    console.log('Submit for quote')
  }

  return (
    <div className="p-4 space-y-6">
      <div>
        <h2 className="text-lg font-semibold text-zinc-900">Review Your Design</h2>
        <p className="text-sm text-zinc-500">
          Confirm your configuration before submitting for a quote.
        </p>
      </div>

      {/* Dimensions summary */}
      <div className="p-4 bg-zinc-50 rounded-lg">
        <h3 className="font-medium mb-2">Dimensions</h3>
        <div className="grid grid-cols-3 gap-4 text-sm">
          <div>
            <span className="text-zinc-500">Width</span>
            <p className="font-semibold">{dimensions.width}mm</p>
          </div>
          <div>
            <span className="text-zinc-500">Depth</span>
            <p className="font-semibold">{dimensions.depth}mm</p>
          </div>
          <div>
            <span className="text-zinc-500">Height</span>
            <p className="font-semibold">{dimensions.height}mm</p>
          </div>
        </div>
      </div>

      {/* Modules summary */}
      <div className="p-4 bg-zinc-50 rounded-lg">
        <h3 className="font-medium mb-2">Modules ({moduleCount})</h3>
        <div className="space-y-2">
          {Array.from(slots.entries()).map(([slotId, config]) => (
            <div key={slotId} className="flex justify-between text-sm">
              <span className="text-zinc-600">{slotId}</span>
              <span className="font-medium">{config.type}</span>
            </div>
          ))}
          {moduleCount === 0 && (
            <p className="text-sm text-zinc-500">No modules configured</p>
          )}
        </div>
      </div>

      {/* Finishes summary */}
      <div className="p-4 bg-zinc-50 rounded-lg">
        <h3 className="font-medium mb-2">Finishes</h3>
        <div className="space-y-2 text-sm">
          <div className="flex justify-between">
            <span className="text-zinc-600">Material</span>
            <span className="font-medium">{finishes.material || '—'}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-zinc-600">Hardware</span>
            <span className="font-medium">{finishes.hardware || '—'}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-zinc-600">Door Profile</span>
            <span className="font-medium">{finishes.doorProfile || '—'}</span>
          </div>
        </div>
      </div>

      {/* Price breakdown */}
      <div className="p-4 bg-white border rounded-lg">
        <h3 className="font-medium mb-3">Estimated Price</h3>
        <div className="space-y-2 text-sm">
          <div className="flex justify-between">
            <span className="text-zinc-600">Base Cabinet</span>
            <span>${basePrice.toLocaleString()}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-zinc-600">Modules ({moduleCount})</span>
            <span>${modulePrice.toLocaleString()}</span>
          </div>
          <div className="border-t pt-2 mt-2 flex justify-between font-semibold">
            <span>Total</span>
            <span>${estimatedTotal.toLocaleString()}</span>
          </div>
        </div>
        <p className="text-xs text-zinc-500 mt-3">
          * Estimate only. Final price confirmed after site measure. ±5% supplier variance may apply.
        </p>
      </div>

      {/* Submit will be wired in Phase 06 */}
    </div>
  )
}
```

Update WizardShell to render StepFinishes and StepReview.
  </action>
  <verify>
Navigate to Step 3 - MaterialPicker shows.
Select material - summary updates.
Navigate to Step 4 - full configuration displayed.
Price breakdown visible with disclaimer.
All 4 steps now functional.
  </verify>
  <done>
StepFinishes and StepReview complete. Full 4-step wizard functional.
  </done>
</task>

</tasks>

<verification>
- Step 3 shows material/hardware/profile selection tabs
- Selecting material updates store and 3D viewport
- Step 4 shows complete configuration summary
- Price breakdown visible (placeholder pricing)
- Variance disclaimer displayed
- All 4 wizard steps navigable
</verification>

<success_criteria>
- Complete finish selection in Step 3
- Real-time 3D material preview
- Comprehensive review in Step 4
- Full wizard flow functional
</success_criteria>

<output>
After completion, create `.planning/phases/04-3d-configurator-core/04-07-SUMMARY.md`
</output>
