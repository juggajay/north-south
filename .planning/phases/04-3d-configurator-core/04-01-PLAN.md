---
phase: 04-3d-configurator-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/stores/useCabinetStore.ts
  - src/stores/useWizardStore.ts
  - src/stores/useHistoryStore.ts
  - src/types/configurator.ts
  - src/components/configurator/Canvas3D.tsx
autonomous: true

must_haves:
  truths:
    - "Three.js and R3F libraries are installed"
    - "Zustand stores exist with typed state"
    - "Canvas3D renders without errors"
  artifacts:
    - path: "src/stores/useCabinetStore.ts"
      provides: "Cabinet configuration state"
      exports: ["useCabinetStore"]
    - path: "src/stores/useWizardStore.ts"
      provides: "Wizard navigation state"
      exports: ["useWizardStore"]
    - path: "src/stores/useHistoryStore.ts"
      provides: "Undo/redo history middleware"
      exports: ["useHistoryStore"]
    - path: "src/types/configurator.ts"
      provides: "TypeScript types for configurator"
      exports: ["CabinetDimensions", "ModuleConfig", "SlotConfig", "FinishConfig"]
    - path: "src/components/configurator/Canvas3D.tsx"
      provides: "R3F Canvas wrapper with performance settings"
      exports: ["Canvas3D"]
  key_links:
    - from: "src/stores/useCabinetStore.ts"
      to: "src/stores/useHistoryStore.ts"
      via: "temporal middleware"
      pattern: "temporal\\("
---

<objective>
Install React Three Fiber ecosystem and create foundational Zustand stores for the 3D configurator.

Purpose: Establishes the core state management and 3D rendering infrastructure that all subsequent plans depend on.
Output: Working R3F Canvas with Zustand stores for cabinet config, wizard steps, and undo/redo history.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-3d-configurator-core/04-RESEARCH.md
@.planning/phases/04-3d-configurator-core/04-CONTEXT.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install R3F ecosystem and create TypeScript types</name>
  <files>
    package.json
    src/types/configurator.ts
  </files>
  <action>
Install React Three Fiber ecosystem:
```bash
npm install three@0.182.0 @react-three/fiber@9.0.4 @react-three/drei@9.122.0
npm install @use-gesture/react zustand react-modal-sheet use-debounce
npm install --save-dev @types/three
```

Note: Use R3F v9.0.4 (not 9.5.0) and drei v9.122.0 for React 19 compatibility.

Create `src/types/configurator.ts` with:
- CabinetDimensions: { width: number, height: number, depth: number } (in mm)
- ModuleType: union of all 12 module type strings
- ModuleConfig: { type: ModuleType, width: number, interiorOptions: {...}, addons: string[] }
- SlotConfig: { id: string, position: 'base' | 'overhead', x: number, module: ModuleConfig | null }
- FinishConfig: { material: string, hardware: string, doorProfile: string }
- CabinetConfig: { dimensions, slots: Map, finishes }
- WizardStep: 'dimensions' | 'layout' | 'finishes' | 'review'
- DesignVersion: { id: string, config: CabinetConfig, timestamp: number }

Include all 12 module types per requirements:
- Base: 'standard', 'sink-base', 'drawer-stack', 'pull-out-pantry', 'corner-base', 'appliance-tower', 'open-shelving'
- Overhead: 'standard-overhead', 'glass-door', 'open-shelf', 'rangehood-space', 'lift-up-door'
  </action>
  <verify>
Run `npm ls three @react-three/fiber @react-three/drei zustand` confirms all installed.
TypeScript compiles: `npm run typecheck` passes.
  </verify>
  <done>
All R3F ecosystem packages installed. TypeScript types for configurator defined and exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zustand stores for cabinet config, wizard, and history</name>
  <files>
    src/stores/useCabinetStore.ts
    src/stores/useWizardStore.ts
    src/stores/useHistoryStore.ts
  </files>
  <action>
Create `src/stores/useCabinetStore.ts`:
- State: dimensions (default 2400x2100x600mm), slots (Map), finishes
- Actions: setDimension, setModule, removeModule, setFinish, resetConfig
- Use Zustand's immer middleware for immutable updates
- Wrap with temporal middleware for undo/redo (limit: 20 states)
- Export getState() for useFrame access (avoid reactive subscriptions in render loop)

Create `src/stores/useWizardStore.ts`:
- State: currentStep (0-3), visitedSteps (Set), validationErrors
- Actions: goToStep, nextStep, prevStep, setValidationError, clearErrors
- Implement strict progression: can only advance if canProceed(currentStep) returns true
- Step 0 (dimensions): width >= 1200, height >= 1800, depth > 0
- Step 1 (layout): at least one module placed
- Step 2 (finishes): material selected
- Step 3 (review): always valid (read-only)
- Once a step is visited, it becomes freely revisitable

Create `src/stores/useHistoryStore.ts`:
- This is a thin wrapper exposing undo/redo from useCabinetStore's temporal middleware
- Export: undo(), redo(), canUndo, canRedo, futureStates.length, pastStates.length
- See Zustand temporal middleware docs: https://github.com/charkour/zundo
  </action>
  <verify>
TypeScript compiles without errors.
Create a quick test in browser console:
```js
// In dev tools after app loads
const store = useCabinetStore.getState()
store.setDimension('width', 3000)
useCabinetStore.temporal.getState().undo()
// Width should revert to 2400
```
  </verify>
  <done>
Three Zustand stores created with proper typing. Undo/redo works with 20-state limit. Wizard validation logic implemented.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Canvas3D wrapper with mobile performance optimizations</name>
  <files>
    src/components/configurator/Canvas3D.tsx
  </files>
  <action>
Create `src/components/configurator/Canvas3D.tsx`:
- R3F Canvas with mobile-first performance settings
- Props: children (React nodes), className (optional)
- Performance settings per RESEARCH.md:
  - dpr: [1, 1.5] (cap at 1.5 for mobile)
  - gl.powerPreference: 'high-performance'
  - gl.antialias: false (mobile perf)
  - frameloop: 'demand' (render only when invalidated)
  - camera: position [2, 1, 3], fov 50 (3/4 view per CONTEXT.md)
- Wrap children in Suspense with loading fallback
- Include PerformanceMonitor from drei that:
  - onIncline: setDpr(1.5)
  - onDecline: setDpr(1)
- Add CSS touch-action: none on container div (CRITICAL for mobile gestures)
- Include basic lighting: ambientLight intensity 0.5, directionalLight from above

Example structure:
```tsx
export function Canvas3D({ children, className }: Canvas3DProps) {
  const [dpr, setDpr] = useState(1.5)

  return (
    <div className={cn("touch-action-none", className)} style={{ touchAction: 'none' }}>
      <Canvas dpr={[1, dpr]} gl={{...}} frameloop="demand" camera={{...}}>
        <Suspense fallback={<Loader />}>
          <PerformanceMonitor onIncline={() => setDpr(1.5)} onDecline={() => setDpr(1)}>
            <ambientLight intensity={0.5} />
            <directionalLight position={[5, 5, 5]} intensity={1} />
            {children}
          </PerformanceMonitor>
        </Suspense>
      </Canvas>
    </div>
  )
}
```

Create a simple Loader component using Html from drei for the Suspense fallback.
  </action>
  <verify>
Create a test page that renders Canvas3D with a simple box:
```tsx
<Canvas3D className="h-[400px]">
  <mesh>
    <boxGeometry args={[1, 1, 1]} />
    <meshStandardMaterial color="orange" />
  </mesh>
</Canvas3D>
```
Box renders without errors. Console shows no warnings about touch-action.
  </verify>
  <done>
Canvas3D wrapper renders with performance optimizations. Lighting configured. Suspense fallback shows during loading.
  </done>
</task>

</tasks>

<verification>
- All packages installed: `npm ls three @react-three/fiber @react-three/drei zustand @use-gesture/react react-modal-sheet`
- TypeScript compiles: `npm run typecheck` passes
- Stores can be imported and used
- Canvas3D renders a test mesh without errors
- touch-action: none applied to canvas container
</verification>

<success_criteria>
- R3F ecosystem fully installed with correct versions
- Zustand stores typed and functional with undo/redo
- Canvas3D renders with mobile performance settings
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-3d-configurator-core/04-01-SUMMARY.md`
</output>
