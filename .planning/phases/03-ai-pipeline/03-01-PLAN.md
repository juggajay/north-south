---
phase: 03-ai-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/ai-pipeline.ts
  - src/lib/query-client.tsx
  - src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "TanStack Query provider wraps the application"
    - "AI pipeline types are defined and exportable"
    - "Pipeline stage progression is type-safe"
  artifacts:
    - path: "src/types/ai-pipeline.ts"
      provides: "Pipeline types"
      exports: ["PipelineStage", "SpaceAnalysis", "Dimensions", "Render", "PipelineResult", "DimensionConfidence"]
    - path: "src/lib/query-client.tsx"
      provides: "TanStack Query provider"
      exports: ["QueryProvider"]
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/lib/query-client.tsx"
      via: "QueryProvider wrapper"
      pattern: "QueryProvider"
---

<objective>
Set up TanStack Query infrastructure and define TypeScript types for the AI pipeline.

Purpose: Foundation layer enabling all subsequent AI API calls with proper type safety and retry logic.
Output: Query client provider integrated into app, comprehensive type definitions for pipeline stages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-pipeline/03-RESEARCH.md
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI Pipeline Types</name>
  <files>src/types/ai-pipeline.ts</files>
  <action>
Create comprehensive TypeScript types for the AI pipeline:

```typescript
// Pipeline stages matching CONTEXT.md decision: Analyzing -> Measuring -> Styling -> Creating
export type PipelineStage = 'analyzing' | 'measuring' | 'styling' | 'creating';

// Dimension confidence tiers (Basic tier for MVP single photo)
export type DimensionConfidence = 'basic' | 'standard' | 'enhanced' | 'precision';

// Space analysis from Claude Vision
export interface SpaceAnalysis {
  roomType: string;
  estimatedWidth: number;  // mm
  estimatedDepth: number;  // mm
  estimatedHeight: number; // mm
  features: string[];      // windows, doors, alcoves
  styleAesthetic: 'modern' | 'traditional' | 'industrial' | 'coastal' | 'scandinavian';
  lightingConditions: 'natural' | 'artificial' | 'mixed';
  flooring: string;
  wallFinishes: string;
}

// Dimension estimation result
export interface Dimensions {
  width: number;   // mm
  depth: number;   // mm
  height: number;  // mm
  confidence: DimensionConfidence;
  confidencePercent: number; // 0-100
  tierLabel: string; // "High confidence" or "Verify dimensions"
}

// Style classification for render generation
export interface StyleMatch {
  id: string;
  name: string;
  description?: string;
  polytech: string[];  // Polytec finish codes
}

// Generated render
export interface Render {
  id: string;
  styleLabel: string;
  styleId: string;
  imageUrl: string;
  imageBase64?: string;
}

// Pipeline progress tracking
export interface PipelineProgress {
  stage: PipelineStage;
  stagesComplete: PipelineStage[];
  error?: string;
}

// Full pipeline result
export interface PipelineResult {
  analysis: SpaceAnalysis;
  dimensions: Dimensions;
  styles: StyleMatch[];
  renders: Render[];
}

// Error types for conditional retry
export interface PipelineError {
  stage: PipelineStage;
  message: string;
  isRetryable: boolean;
  statusCode?: number;
}
```

Export all types. Use interfaces (not types) for objects to allow extension.
  </action>
  <verify>`npm run typecheck` passes with new types</verify>
  <done>All pipeline types defined and exported from src/types/ai-pipeline.ts</done>
</task>

<task type="auto">
  <name>Task 2: Set Up TanStack Query Provider</name>
  <files>src/lib/query-client.tsx</files>
  <action>
Install TanStack Query and create provider:

```bash
npm install @tanstack/react-query
```

Create QueryProvider with retry configuration from RESEARCH.md:

```typescript
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useState, ReactNode } from 'react';

function makeQueryClient() {
  return new QueryClient({
    defaultOptions: {
      queries: {
        // Stale time of 5 minutes for cached data
        staleTime: 5 * 60 * 1000,
        // Retry only on 5xx errors, not 4xx
        retry: (failureCount, error: any) => {
          if (error?.status >= 400 && error?.status < 500) return false;
          return failureCount < 3;
        },
        // Exponential backoff: 1s, 2s, 4s (capped at 30s)
        retryDelay: (attemptIndex) =>
          Math.min(1000 * 2 ** attemptIndex, 30000),
      },
      mutations: {
        // Same retry logic for mutations
        retry: (failureCount, error: any) => {
          if (error?.status >= 400 && error?.status < 500) return false;
          return failureCount < 3;
        },
        retryDelay: (attemptIndex) =>
          Math.min(1000 * 2 ** attemptIndex, 30000),
      },
    },
  });
}

let browserQueryClient: QueryClient | undefined;

function getQueryClient() {
  if (typeof window === 'undefined') {
    // Server: always make a new query client
    return makeQueryClient();
  }
  // Browser: make a new query client if we don't already have one
  if (!browserQueryClient) {
    browserQueryClient = makeQueryClient();
  }
  return browserQueryClient;
}

export function QueryProvider({ children }: { children: ReactNode }) {
  const queryClient = getQueryClient();

  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
}
```

Use 'use client' directive since this is a client-side provider.
  </action>
  <verify>`npm run typecheck` passes, QueryProvider exported</verify>
  <done>TanStack Query provider with retry logic ready for use</done>
</task>

<task type="auto">
  <name>Task 3: Integrate QueryProvider into App Layout</name>
  <files>src/app/layout.tsx</files>
  <action>
Wrap the application with QueryProvider in the root layout.

Import QueryProvider and wrap it around the children, inside ConvexAuthProvider but outside the main content:

```typescript
import { QueryProvider } from '@/lib/query-client';

// In the layout component, wrap children:
<ConvexAuthProvider client={convex}>
  <QueryProvider>
    {children}
  </QueryProvider>
</ConvexAuthProvider>
```

The order should be:
1. ConvexAuthProvider (outermost, for auth context)
2. QueryProvider (for TanStack Query)
3. ThemeProvider if present
4. children (innermost)

Ensure 'use client' is at the top if not already present.
  </action>
  <verify>`npm run build` succeeds, no provider errors in console</verify>
  <done>QueryProvider integrated into app, ready for pipeline hooks</done>
</task>

</tasks>

<verification>
- [ ] `npm run typecheck` passes
- [ ] `npm run build` succeeds (or progresses to Convex blocker)
- [ ] Types importable: `import { PipelineStage, SpaceAnalysis } from '@/types/ai-pipeline'`
- [ ] QueryProvider wraps the app in layout.tsx
</verification>

<success_criteria>
- TanStack Query v5 installed and configured
- All pipeline types defined with proper exports
- QueryProvider integrated into root layout
- Retry logic configured for 5xx errors only
- Foundation ready for AI client implementations
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-pipeline/03-01-SUMMARY.md`
</output>
