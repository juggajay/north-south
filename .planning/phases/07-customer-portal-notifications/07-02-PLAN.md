---
phase: 07-customer-portal-notifications
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - convex/notifications/templates/OrderConfirmed.tsx
  - convex/notifications/templates/ProductionStarted.tsx
  - convex/notifications/templates/QCComplete.tsx
  - convex/notifications/templates/ReadyToShip.tsx
  - convex/notifications/templates/Delivered.tsx
  - convex/notifications/templates/PostInstall.tsx
  - convex/notifications/sendEmail.ts
  - convex/orders.ts
autonomous: true

must_haves:
  truths:
    - "Emails sent when order status changes"
    - "Emails are text-only with portal link"
    - "Post-install email sent 7 days after delivered"
    - "Post-install email includes review CTA"
    - "Email tone is professional but approachable"
  artifacts:
    - path: "convex/notifications/templates/OrderConfirmed.tsx"
      provides: "Order confirmed email template"
      min_lines: 20
    - path: "convex/notifications/templates/PostInstall.tsx"
      provides: "Post-install email with review CTA"
      contains: "Leave a Review"
    - path: "convex/notifications/sendEmail.ts"
      provides: "Unified email sending function"
      exports: ["sendNotificationEmail"]
  key_links:
    - from: "convex/orders.ts"
      to: "convex/notifications/sendEmail.ts"
      via: "ctx.scheduler.runAfter on status change"
      pattern: "scheduler\\.runAfter.*internal\\.notifications"
    - from: "convex/notifications/sendEmail.ts"
      to: "convex/notifications.ts"
      via: "resend.sendEmail"
      pattern: "resend\\.sendEmail"
---

<objective>
Create email notification system: 6 email templates following React Email patterns, unified sending function, and automatic triggers on order status changes.

Purpose: Keep customers informed at key milestones with brief, friendly updates. Text-only emails load fast and avoid spam filters.

Output: All 6 email templates, sending infrastructure, and automatic email triggers when order status changes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-customer-portal-notifications/07-CONTEXT.md
@.planning/phases/07-customer-portal-notifications/07-RESEARCH.md
@convex/notifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email templates with React Email</name>
  <files>
    convex/notifications/templates/OrderConfirmed.tsx
    convex/notifications/templates/ProductionStarted.tsx
    convex/notifications/templates/QCComplete.tsx
    convex/notifications/templates/ReadyToShip.tsx
    convex/notifications/templates/Delivered.tsx
    convex/notifications/templates/PostInstall.tsx
  </files>
  <action>
    Create 6 email templates using @react-email/components. Each template:
    - Uses "use node" directive at top (required for Convex)
    - Imports Html, Text, Link, Container, Section from @react-email/components
    - Accepts typed props (customerName, orderNumber, portalUrl)
    - Returns JSX for email body
    - Exports render function that returns { html, text }

    **Tone per CONTEXT.md:** Professional but approachable, tradesperson authenticity. Sign off with "Cheers" not "Best regards".

    **Content per CONTEXT.md:** Brief updates - status change + one line context + link to portal (2-3 sentences).

    1. **OrderConfirmed.tsx** (NOTIF-001):
       Subject: "Order Confirmed - {orderNumber}"
       Body: Thanks for your order. Deposit received, panels scheduled for production. [Track your order]

    2. **ProductionStarted.tsx** (NOTIF-002):
       Subject: "Production Started - {orderNumber}"
       Body: Your panels are being cut today! We'll send photos as they come together. [View progress]

    3. **QCComplete.tsx** (NOTIF-003):
       Subject: "Quality Check Complete - {orderNumber}"
       Body: Your panels passed QC - everything looks great. Getting them ready to ship. [See photos]

    4. **ReadyToShip.tsx** (NOTIF-004):
       Subject: "Ready to Ship - {orderNumber}"
       Body: Your order is packed and ready. You'll receive tracking details shortly. [Track delivery]

    5. **Delivered.tsx** (NOTIF-005):
       Subject: "Delivered - {orderNumber}"
       Body: Your panels have arrived! Check out the installation guides in your portal. [View guides]

    6. **PostInstall.tsx** (NOTIF-006):
       Subject: "How's it looking? - {orderNumber}"
       Body: Hope your new panels are looking great! If you're happy, a quick review helps:
       [Leave a Review] (prominent CTA button per CONTEXT.md)
       Know someone planning a kitchen? Share your referral link: {referralUrl}
       Sign off with "Cheers, North South Carpentry"

    Each template must render both HTML and plaintext via @react-email/render.
  </action>
  <verify>
    - All 6 template files created in convex/notifications/templates/
    - Each file has "use node" directive
    - Each exports a render function returning { html, text }
    - PostInstall.tsx includes clear review CTA button
    - Tone matches CONTEXT.md guidelines
  </verify>
  <done>
    All 6 email templates created with consistent tone, structure, and plaintext support. Ready to be sent via notification system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unified email sending function</name>
  <files>
    convex/notifications/sendEmail.ts
  </files>
  <action>
    Create convex/notifications/sendEmail.ts as the central email dispatch:

    1. Import resend instance from ../notifications.ts
    2. Import all 6 templates from ./templates/
    3. Import internal from "../_generated/api"
    4. Import internalMutation, internalAction from "../_generated/server"

    5. Create sendNotificationEmail internalAction:
       - Args: orderId, type (union of 6 notification types), to (email)
       - Fetch order data from DB
       - Fetch submission for customer name
       - Build portalUrl: `${process.env.SITE_URL}/portal/${orderId}`
       - Select template based on type
       - Render template with props
       - Call resend.sendEmail with:
         - from: "North South Carpentry <orders@northsouthcarpentry.com>"
         - to: recipient email
         - subject: template-specific subject with orderNumber
         - html: rendered HTML
         - text: rendered plaintext

    6. Create logNotification internalMutation:
       - Insert record into notifications table
       - Fields: orderId, type, channel: "email", recipient, sentAt, status

    7. Handle errors gracefully:
       - Log errors to notifications table with status "failed"
       - Don't throw - let order status update succeed even if email fails

    Notification types enum:
    - "order_confirmed" -> OrderConfirmed template
    - "production_started" -> ProductionStarted template
    - "qc_complete" -> QCComplete template
    - "ready_to_ship" -> ReadyToShip template
    - "delivered" -> Delivered template
    - "post_install" -> PostInstall template
  </action>
  <verify>
    - convex/notifications/sendEmail.ts compiles without errors
    - sendNotificationEmail action exported
    - All 6 notification types handled in switch/map
    - Error handling doesn't throw (logs to DB instead)
  </verify>
  <done>
    Unified email sending function complete. Takes order ID and notification type, renders appropriate template, sends via Resend.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire email triggers to order status updates</name>
  <files>
    convex/orders.ts
  </files>
  <action>
    Update convex/orders.ts updateStatus mutation to trigger emails:

    1. Import internal from "./_generated/api"
    2. After updating order status and timeline, determine if email should be sent
    3. Map status to notification type:
       - "confirmed" -> "order_confirmed"
       - "production" -> "production_started"
       - "qc" -> "qc_complete"
       - "ready_to_ship" -> "ready_to_ship"
       - "delivered" -> "delivered"
       - "complete" -> null (no email for complete)

    4. If notification type exists:
       - Get submission to find customer email
       - Schedule email via ctx.scheduler.runAfter(0, internal.notifications.sendEmail.sendNotificationEmail, {...})
       - Non-blocking: status update returns immediately, email sends async

    5. Special case for "delivered" status:
       - Also schedule post_install email 7 days later
       - Use ctx.scheduler.runAt() with timestamp = Date.now() + (7 * 24 * 60 * 60 * 1000)
       - This handles NOTIF-006 per requirements

    Important per RESEARCH.md Pitfall 4: Do NOT await the email send. Use scheduler for non-blocking execution.
  </action>
  <verify>
    - updateStatus mutation compiles without errors
    - Email scheduled (not awaited) on status change
    - Post-install email scheduled for 7 days after delivered
    - Status update returns immediately (no blocking on email)
  </verify>
  <done>
    Email triggers wired to order status changes. Emails send asynchronously without blocking UI. Post-install scheduled automatically 7 days after delivery.
  </done>
</task>

</tasks>

<verification>
Email system verification:
1. Run `npx convex dev` - all functions push without errors
2. Test template rendering (manual - check HTML/text output in logs)
3. Test status update triggers scheduler (check Convex dashboard scheduled functions)
4. Verify post-install email scheduled 7 days out when delivered status set
5. Test email sending with Resend test mode (if API key configured)
</verification>

<success_criteria>
- All 6 email templates created with proper React Email structure
- Templates render both HTML and plaintext
- Tone matches CONTEXT.md: professional, approachable, "Cheers" sign-off
- PostInstall has prominent review CTA, not buried
- Email sending is non-blocking (scheduler.runAfter)
- Post-install scheduled automatically 7 days after delivered
- Errors logged to DB, don't break status updates
</success_criteria>

<output>
After completion, create `.planning/phases/07-customer-portal-notifications/07-02-SUMMARY.md`
</output>
