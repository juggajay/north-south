---
phase: 07-customer-portal-notifications
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/portal/OrderTimeline.tsx
  - src/components/portal/TimelineStep.tsx
  - src/components/portal/DocumentList.tsx
  - src/components/portal/ProductionGallery.tsx
  - src/components/portal/ReferralTracker.tsx
  - src/app/(tabs)/orders/page.tsx
  - src/app/portal/[orderId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Customer can see current order status"
    - "Timeline shows completed + upcoming milestones"
    - "Completed steps show checkmark + timestamp"
    - "Documents downloadable by tapping"
    - "Production photos viewable in gallery"
    - "Referral link generated and copyable"
  artifacts:
    - path: "src/components/portal/OrderTimeline.tsx"
      provides: "Vertical stepper timeline"
      min_lines: 50
    - path: "src/components/portal/DocumentList.tsx"
      provides: "Download-only document list"
      contains: "Download"
    - path: "src/components/portal/ReferralTracker.tsx"
      provides: "Referral status display"
      min_lines: 30
    - path: "src/app/portal/[orderId]/page.tsx"
      provides: "Order detail page"
      min_lines: 80
  key_links:
    - from: "src/app/(tabs)/orders/page.tsx"
      to: "/portal/[orderId]"
      via: "navigation link"
      pattern: "href.*portal"
    - from: "src/components/portal/OrderTimeline.tsx"
      to: "convex/orders.ts"
      via: "useQuery for order data"
      pattern: "useQuery.*api\\.orders"
---

<objective>
Create customer portal UI: vertical order timeline, document downloads, production photos gallery, referral tracking, and integrate with enhanced Orders tab.

Purpose: Give customers visibility into their order progress with a clean, mobile-friendly interface. Keep them engaged and informed without needing to contact support.

Output: Full portal UI components and enhanced Orders page with navigation to order details.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-customer-portal-notifications/07-CONTEXT.md
@.planning/phases/07-customer-portal-notifications/07-RESEARCH.md
@src/app/(tabs)/orders/page.tsx
@src/components/wizard/StepIndicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OrderTimeline and TimelineStep components</name>
  <files>
    src/components/portal/OrderTimeline.tsx
    src/components/portal/TimelineStep.tsx
  </files>
  <action>
    Create vertical stepper timeline following existing wizard StepIndicator patterns but adapted for vertical layout per CONTEXT.md.

    **src/components/portal/TimelineStep.tsx:**
    - Props: step (id, name), isCompleted, isCurrent, timestamp, isLast
    - Vertical layout with connecting line to next step
    - Completed: Checkmark icon (Check from lucide-react) + timestamp only (no notes per CONTEXT.md)
    - Current/Active: Expanded card with more detail (status description, what happens next)
    - Future: Muted, show sequence without estimated dates per CONTEXT.md
    - Use cn() for conditional classes
    - Framer-motion for subtle fade-in on completion

    **src/components/portal/OrderTimeline.tsx:**
    - Props: currentStatus (string), timeline (object with timestamps)
    - Define ORDER_STEPS array matching ORD-001 through ORD-008:
      ```typescript
      const ORDER_STEPS = [
        { id: "confirmed", name: "Order Confirmed", description: "Deposit received, production scheduled" },
        { id: "production", name: "In Production", description: "Your panels are being manufactured" },
        { id: "qc", name: "QC Complete", description: "Quality check passed" },
        { id: "ready_to_ship", name: "Ready to Ship", description: "Packed and awaiting dispatch" },
        { id: "shipped", name: "Shipped", description: "On the way to you" },
        { id: "delivered", name: "Delivered", description: "Your order has arrived" },
        { id: "complete", name: "Complete", description: "Project finished" },
      ];
      ```
    - Calculate currentIndex from currentStatus
    - Map steps to TimelineStep components
    - Format timestamps with toLocaleDateString for completed steps

    Styling per CONTEXT.md "Claude's Discretion":
    - Vertical line connecting steps: 2px zinc-200, zinc-900 when completed
    - Step circles: 32px, zinc-900 bg when completed, zinc-200 border when future
    - Current step card: white bg, shadow-sm, p-4, rounded-lg
  </action>
  <verify>
    - Both components compile without TypeScript errors
    - OrderTimeline renders all 7 steps in correct order
    - Completed steps show checkmark + timestamp
    - Current step shows expanded card
    - Future steps are muted without dates
  </verify>
  <done>
    Vertical stepper timeline complete. Visually tracks order progress from confirmed through complete with appropriate detail at each state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DocumentList, ProductionGallery, ReferralTracker components</name>
  <files>
    src/components/portal/DocumentList.tsx
    src/components/portal/ProductionGallery.tsx
    src/components/portal/ReferralTracker.tsx
  </files>
  <action>
    **src/components/portal/DocumentList.tsx:**
    - Props: orderId
    - Use useQuery to fetch documents from api.documents.list
    - Group by type per CONTEXT.md: separate sections for Quotes and Invoices
    - Each document shows: fileName, version number, date
    - Download-only per CONTEXT.md: tap triggers browser download, no preview
    - Use Download icon from lucide-react
    - Get download URL from api.documents.getDownloadUrl
    - Empty state if no documents: "Documents will appear here once your quote is ready"

    **src/components/portal/ProductionGallery.tsx:**
    - Props: orderId
    - Use useQuery to fetch photos from api.productionPhotos.listByOrder (create this query if needed)
    - Simple grid layout: 3 columns on mobile, responsive
    - Each photo: thumbnail with caption if provided
    - Tap to view full-size in lightbox (use framer-motion for animation)
    - Empty state: "Production photos will appear as your panels are made"
    - Photos grouped by milestone (production, qc, packaging, delivery)

    **src/components/portal/ReferralTracker.tsx:**
    - Props: none (uses current user from auth)
    - Use useQuery for api.referrals.getMyReferrals
    - Display referral link (useQuery api.referrals.getReferralLink)
    - Copy link button with clipboard API and toast feedback
    - List of referrals: masked email (j***n@example.com), status badge, reward amount if rewarded
    - Status badge colors: pending (yellow), signed_up (blue), ordered (purple), rewarded (green)
    - Empty state: "Share your link to earn rewards when friends order"

    Note: productionPhotos.listByOrder query may need to be created in convex/orders.ts or separate convex/productionPhotos.ts
  </action>
  <verify>
    - All 3 components compile without TypeScript errors
    - DocumentList groups documents by type
    - DocumentList triggers download on tap
    - ProductionGallery displays photos in grid
    - ReferralTracker shows link and referral list
    - Copy button works with clipboard API
    - Empty states display correctly
  </verify>
  <done>
    Portal section components complete. Documents download on tap, photos display in gallery, referrals tracked with copy-able link.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create order detail page and enhance Orders tab</name>
  <files>
    src/app/portal/[orderId]/page.tsx
    src/app/(tabs)/orders/page.tsx
  </files>
  <action>
    **src/app/portal/[orderId]/page.tsx:**
    Create full order detail page:
    1. "use client" directive
    2. Extract orderId from params
    3. Use useQuery to fetch order with api.orders.get
    4. Auth check: require login, redirect if not authenticated
    5. Layout sections (scrollable, pb-24 for bottom nav):
       - Header: Back button, order number, current status badge
       - OrderTimeline component (prominent, first section)
       - DocumentList component (collapsible section)
       - ProductionGallery component (collapsible section)
       - Chat access button: "Need Help?" linking to /chat
    6. Loading skeleton while order loads
    7. 404 handling if order not found

    Sections per CONTEXT.md PORT-001 through PORT-006:
    - Order Status: OrderTimeline
    - Documents: DocumentList
    - Production Photos: ProductionGallery
    - Chat/Support: Button linking to chat tab

    Note: Installation guides (PORT-004) are placeholder for videos - show "Coming soon" message

    **src/app/(tabs)/orders/page.tsx:**
    Enhance existing page:
    1. Keep current list view of submissions
    2. For submissions with status "ordered", show order card instead
    3. Add navigation: tap order card â†’ navigate to /portal/[orderId]
    4. Add "View Details" button on each card
    5. For orders (not just submissions), fetch order data to show timeline preview
    6. Add ReferralTracker section at bottom of page (outside submission list)
  </action>
  <verify>
    - Order detail page loads at /portal/[orderId]
    - All sections render correctly (timeline, documents, photos)
    - Navigation from Orders tab to detail page works
    - Back button returns to Orders tab
    - Chat access button visible
    - ReferralTracker visible on Orders tab
    - Auth enforced on portal page
  </verify>
  <done>
    Customer portal UI complete. Orders tab shows list with navigation to detail pages. Detail pages show full timeline, documents, photos, and chat access.
  </done>
</task>

</tasks>

<verification>
Portal UI verification:
1. Navigate to Orders tab - see submissions list
2. Tap on an order - navigate to /portal/[orderId]
3. Verify timeline shows correct status and timestamps
4. Verify documents section (will be empty until admin uploads)
5. Verify photos section (will be empty until admin uploads)
6. Verify "Need Help?" links to chat
7. Verify back navigation works
8. Verify referral tracker shows on Orders tab
9. Test copy referral link button
</verification>

<success_criteria>
- OrderTimeline shows vertical stepper with 7 steps
- Completed steps show checkmark + timestamp only
- Current step shows expanded card with detail
- Future steps show sequence without dates
- Documents download-only (no preview)
- Photos display in grid gallery
- Referral link copyable with feedback
- Order detail page accessible from Orders tab
- Chat access available from portal
- All components mobile-friendly (thumb zone, touch targets)
</success_criteria>

<output>
After completion, create `.planning/phases/07-customer-portal-notifications/07-03-SUMMARY.md`
</output>
