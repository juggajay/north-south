---
phase: 07-customer-portal-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/convex.config.ts
  - convex/orders.ts
  - convex/documents.ts
  - convex/panels.ts
  - convex/referrals.ts
  - convex/notifications.ts
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery for order notifications"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify domain (optional for MVP, can use onboarding@resend.dev)"
        location: "Resend Dashboard -> Domains"

must_haves:
  truths:
    - "Orders can be created from submissions"
    - "Order status updates track timeline"
    - "Documents can be stored and retrieved by order"
    - "Panel QR codes can be looked up publicly"
    - "Referrals can be tracked per user"
  artifacts:
    - path: "convex/convex.config.ts"
      provides: "Resend component registration"
      contains: "app.use(resend)"
    - path: "convex/orders.ts"
      provides: "Order CRUD operations"
      exports: ["create", "get", "getBySubmission", "updateStatus", "listByUserId"]
    - path: "convex/documents.ts"
      provides: "Document management"
      exports: ["upload", "list", "getDownloadUrl"]
    - path: "convex/panels.ts"
      provides: "Panel QR lookup"
      exports: ["lookupByQrCode"]
    - path: "convex/referrals.ts"
      provides: "Referral tracking"
      exports: ["create", "getMyReferrals", "getReferralLink"]
  key_links:
    - from: "convex/orders.ts"
      to: "convex/submissions.ts"
      via: "submissionId reference"
      pattern: "ctx\\.db\\.get\\(.*submissionId"
    - from: "convex/documents.ts"
      to: "convex storage"
      via: "storage.getUrl"
      pattern: "storage\\.getUrl"
---

<objective>
Backend foundation for customer portal: order management, document storage, panel QR lookup, referral tracking, and Resend email component setup.

Purpose: Establish the data layer and API that portal UI and email notifications will consume. This is the foundation that enables all Phase 07 features.

Output: Convex functions for orders, documents, panels, referrals, plus Resend component wired up for email sending.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-customer-portal-notifications/07-CONTEXT.md
@.planning/phases/07-customer-portal-notifications/07-RESEARCH.md
@convex/schema.ts
@convex/submissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Resend packages and configure Convex component</name>
  <files>
    package.json
    convex/convex.config.ts
    convex/notifications.ts
  </files>
  <action>
    1. Install email packages:
       ```bash
       npm install @convex-dev/resend @react-email/components @react-email/render
       ```

    2. Create convex/convex.config.ts to register the Resend component:
       ```typescript
       import { defineApp } from "convex/server";
       import resend from "@convex-dev/resend/convex.config.js";

       const app = defineApp();
       app.use(resend);
       export default app;
       ```

    3. Create convex/notifications.ts with Resend initialization:
       - Import and initialize Resend from @convex-dev/resend
       - Set testMode: false for production
       - Export the resend instance for use in other files
       - Create placeholder internal mutation for sending emails (templates added in Plan 02)

    Note: RESEND_API_KEY will be set in Convex dashboard - code works without it but emails won't send until configured.
  </action>
  <verify>
    - npm install completes without errors
    - convex/convex.config.ts exists with resend component registered
    - convex/notifications.ts exports resend instance
    - npx convex dev runs without errors (may warn about missing API key)
  </verify>
  <done>
    Resend component installed and configured. Ready to send emails once API key is set in Convex dashboard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create orders and documents Convex functions</name>
  <files>
    convex/orders.ts
    convex/documents.ts
  </files>
  <action>
    1. Create convex/orders.ts with:
       - create mutation: Creates order from submission with orderNumber (format: NS-YYYYMMDD-XXX), initial status "confirmed", and empty timeline
       - get query: Get order by ID with submission data
       - getBySubmission query: Get order for a submission
       - listByUserId query: Get all orders for a user (via submission's userId)
       - updateStatus mutation: Update status and add timestamp to timeline object
         - Valid statuses: "confirmed", "production", "qc", "ready_to_ship", "shipped", "delivered", "complete"
         - Maps status to timeline field: confirmed->confirmed, production->productionStart, qc->qcComplete, ready_to_ship->readyToShip, shipped->shipped, delivered->delivered
         - Returns the updated order
       - getTimeline query: Get timeline data for an order

    2. Create convex/documents.ts with:
       - Schema note: documents table already exists in schema? If not, add to schema:
         ```typescript
         documents: defineTable({
           orderId: v.id("orders"),
           type: v.union(v.literal("quote"), v.literal("invoice")),
           version: v.number(),
           fileName: v.string(),
           storageId: v.string(),
           createdAt: v.number(),
         }).index("by_orderId", ["orderId"])
         ```
       - upload mutation: Store document with type, version (auto-increment per type), fileName, storageId
       - list query: Get documents for an order, grouped by type (quotes, invoices) per CONTEXT.md
       - getDownloadUrl query: Get temporary download URL from Convex storage
       - generateUploadUrl mutation: For admin to upload documents (Phase 08 will use this)

    Important: Check if documents table exists in schema.ts first. If not, add it.
  </action>
  <verify>
    - convex/orders.ts compiles without TypeScript errors
    - convex/documents.ts compiles without TypeScript errors
    - npx convex dev pushes schema successfully (if schema modified)
    - Order creation works via Convex dashboard test
  </verify>
  <done>
    Order management and document storage APIs complete. Orders can be created from submissions, status updated with timeline tracking, documents stored and retrieved.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create panels and referrals Convex functions</name>
  <files>
    convex/panels.ts
    convex/referrals.ts
  </files>
  <action>
    1. Create convex/panels.ts with:
       - lookupByQrCode query (PUBLIC - no auth check per CONTEXT.md):
         - Takes qrCode string argument
         - Queries panelQrCodes table by_qrCode index
         - Returns ONLY basic info per CONTEXT.md: panelName, dimensions, material, finish
         - Updates scannedAt timestamp on the record
         - Returns null if not found
       - createPanelQr mutation (for admin in Phase 08):
         - Creates panelQrCodes record with orderId, panelId, qrCode, moduleInfo
         - qrCode format: {orderId}-{panelId} (simple, unique)

    2. Create convex/referrals.ts with:
       - create mutation: Create referral with referrerId, referredEmail, status "pending", createdAt
       - getMyReferrals query (authenticated):
         - Get all referrals for current user
         - Mask email for privacy (j***n@example.com pattern)
         - Return status, rewardAmount, createdAt
       - getReferralLink query (authenticated):
         - Generate unique referral link for user
         - Format: https://northsouthcarpentry.com/ref/{userId} (or similar)
       - updateStatus mutation (for admin):
         - Update referral status: pending -> signed_up -> ordered -> rewarded
         - Set rewardAmount when status becomes "rewarded"

    Note: Referral reward logic stays manual for MVP per RESEARCH.md open question.
  </action>
  <verify>
    - convex/panels.ts compiles without TypeScript errors
    - convex/referrals.ts compiles without TypeScript errors
    - lookupByQrCode returns null for non-existent codes (test via Convex dashboard)
    - Referral queries work for authenticated users
  </verify>
  <done>
    Panel QR lookup (public) and referral tracking (authenticated) APIs complete. Installers can scan panels without login, customers can track their referrals.
  </done>
</task>

</tasks>

<verification>
Backend verification:
1. Run `npx convex dev` - should push all functions without errors
2. Test order creation in Convex dashboard:
   - Create a test order from existing submission
   - Verify orderNumber format (NS-YYYYMMDD-XXX)
   - Update status and verify timeline populates
3. Test panel lookup returns null for invalid QR codes
4. Test referral creation and retrieval
5. Verify Resend component registered (may warn about API key)
</verification>

<success_criteria>
- All 5 Convex files created and functional
- Order CRUD with timeline tracking operational
- Document storage/retrieval working with Convex storage
- Panel QR lookup public (no auth required)
- Referral tracking with privacy masking
- Resend component registered and ready for email templates
- No TypeScript errors, all functions push to Convex
</success_criteria>

<output>
After completion, create `.planning/phases/07-customer-portal-notifications/07-01-SUMMARY.md`
</output>
