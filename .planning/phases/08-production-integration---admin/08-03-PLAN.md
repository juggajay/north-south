---
phase: 08-production-integration-admin
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/orders.ts
  - src/app/admin/orders/page.tsx
  - src/components/admin/OrderList.tsx
  - src/components/admin/OrderCard.tsx
  - src/components/admin/OrderStatusActions.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of all orders"
    - "Admin can see order status and timeline"
    - "Admin can update order status through workflow"
    - "Status transitions follow defined workflow"
  artifacts:
    - path: "src/app/admin/orders/page.tsx"
      provides: "Admin order management page"
      min_lines: 20
    - path: "src/components/admin/OrderList.tsx"
      provides: "Order list with real-time updates"
      exports: ["OrderList"]
    - path: "src/components/admin/OrderCard.tsx"
      provides: "Individual order card with expand/collapse"
      exports: ["OrderCard"]
    - path: "src/components/admin/OrderStatusActions.tsx"
      provides: "Status transition buttons"
      exports: ["OrderStatusActions"]
  key_links:
    - from: "src/components/admin/OrderList.tsx"
      to: "convex/orders.ts"
      via: "useQuery subscription"
      pattern: "useQuery\\(api\\.orders"
    - from: "src/components/admin/OrderStatusActions.tsx"
      to: "convex/orders.ts"
      via: "useMutation for status update"
      pattern: "useMutation\\(api\\.orders\\.updateStatus"
---

<objective>
Create admin order management UI with status workflow.

Purpose: Enable admin to view all orders, see status/timeline, and progress orders through production workflow.
Output: Admin orders page with order list, detail view, and status management.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-production-integration---admin/08-RESEARCH.md

# Existing admin patterns from Phase 06
@src/app/admin/submissions/page.tsx
@src/components/dashboard/SubmissionQueue.tsx
@src/components/dashboard/StatusBadge.tsx

# Orders infrastructure from Phase 07
@convex/orders.ts
@convex/submissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add listAll and get queries to orders API</name>
  <files>convex/orders.ts</files>
  <action>
Add queries to list all orders for admin dashboard and get a single order by ID (similar to submissions.listAll):

Add these queries to convex/orders.ts:

```typescript
/**
 * List all orders for admin dashboard
 */
export const listAll = query({
  args: {},
  handler: async (ctx) => {
    const orders = await ctx.db
      .query("orders")
      .order("desc") // Most recent first
      .take(100);

    // Enrich with submission and design data
    const enriched = await Promise.all(
      orders.map(async (order) => {
        const submission = await ctx.db.get(order.submissionId);
        let design = null;
        if (submission) {
          design = await ctx.db.get(submission.designId);
        }
        return {
          ...order,
          submission,
          design,
        };
      })
    );

    return enriched;
  },
});

/**
 * Get a single order by ID with enriched data
 * Used by QR labels page and order detail views
 */
export const get = query({
  args: {
    id: v.id("orders"),
  },
  handler: async (ctx, args) => {
    const order = await ctx.db.get(args.id);
    if (!order) {
      return null;
    }

    // Enrich with submission and design data
    const submission = await ctx.db.get(order.submissionId);
    let design = null;
    if (submission) {
      design = await ctx.db.get(submission.designId);
    }

    return {
      ...order,
      submission,
      design,
    };
  },
});
```

This follows the same pattern as submissions.listAll and submissions.get from Phase 06.
  </action>
  <verify>npx tsc --noEmit convex/orders.ts shows no errors</verify>
  <done>listAll and get queries added to orders API</done>
</task>

<task type="auto">
  <name>Task 2: Create order status and list components</name>
  <files>src/components/admin/OrderStatusActions.tsx, src/components/admin/OrderCard.tsx, src/components/admin/OrderList.tsx</files>
  <action>
Create the admin order management components:

**src/components/admin/OrderStatusActions.tsx:**
```typescript
"use client";

import { useMutation } from "convex/react";
import { api } from "../../../convex/_generated/api";
import type { Id } from "../../../convex/_generated/dataModel";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { Loader2 } from "lucide-react";
import { useState } from "react";

// Status workflow from RESEARCH.md
const STATUS_TRANSITIONS: Record<string, string[]> = {
  confirmed: ["production"],
  production: ["qc"],
  qc: ["ready_to_ship"],
  ready_to_ship: ["shipped"],
  shipped: ["delivered"],
  delivered: ["complete"],
  complete: [],
};

const STATUS_LABELS: Record<string, string> = {
  confirmed: "Confirmed",
  production: "In Production",
  qc: "QC Complete",
  ready_to_ship: "Ready to Ship",
  shipped: "Shipped",
  delivered: "Delivered",
  complete: "Complete",
};

interface OrderStatusActionsProps {
  orderId: Id<"orders">;
  currentStatus: string;
}

export function OrderStatusActions({ orderId, currentStatus }: OrderStatusActionsProps) {
  const [updating, setUpdating] = useState<string | null>(null);
  const updateStatus = useMutation(api.orders.updateStatus);

  const nextStatuses = STATUS_TRANSITIONS[currentStatus] || [];

  if (nextStatuses.length === 0) {
    return (
      <span className="text-sm text-zinc-500">
        Order complete - no further actions
      </span>
    );
  }

  const handleStatusChange = async (newStatus: string) => {
    setUpdating(newStatus);
    try {
      await updateStatus({ id: orderId, status: newStatus });
      toast.success(`Order updated to ${STATUS_LABELS[newStatus]}`);
    } catch (error) {
      toast.error("Failed to update order status");
      console.error(error);
    } finally {
      setUpdating(null);
    }
  };

  return (
    <div className="flex flex-wrap gap-2">
      {nextStatuses.map((status) => (
        <Button
          key={status}
          variant="outline"
          size="sm"
          onClick={() => handleStatusChange(status)}
          disabled={updating !== null}
        >
          {updating === status && <Loader2 className="h-3 w-3 mr-1 animate-spin" />}
          Move to {STATUS_LABELS[status]}
        </Button>
      ))}
    </div>
  );
}
```

**src/components/admin/OrderCard.tsx:**
```typescript
"use client";

import { useState } from "react";
import { ChevronDown, ChevronUp, Clock, User, Mail, Package } from "lucide-react";
import type { Id } from "../../../convex/_generated/dataModel";
import { OrderStatusActions } from "./OrderStatusActions";

// Reuse StatusBadge from Phase 06
const ORDER_STATUS_COLORS: Record<string, string> = {
  confirmed: "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",
  production: "bg-violet-100 text-violet-800 dark:bg-violet-900 dark:text-violet-200",
  qc: "bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200",
  ready_to_ship: "bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200",
  shipped: "bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200",
  delivered: "bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200",
  complete: "bg-zinc-100 text-zinc-800 dark:bg-zinc-700 dark:text-zinc-200",
};

function OrderStatusBadge({ status }: { status: string }) {
  const colorClass = ORDER_STATUS_COLORS[status] || "bg-zinc-100 text-zinc-800";
  const label = status.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());

  return (
    <span className={`px-2 py-1 rounded-full text-xs font-medium ${colorClass}`}>
      {label}
    </span>
  );
}

interface OrderCardProps {
  order: {
    _id: Id<"orders">;
    orderNumber: string;
    status: string;
    timeline?: Record<string, number>;
    createdAt: number;
    submission?: {
      name: string;
      email: string;
      siteMeasure: boolean;
      installQuote: boolean;
    } | null;
    design?: {
      productType: string;
      config?: any;
    } | null;
  };
}

export function OrderCard({ order }: OrderCardProps) {
  const [expanded, setExpanded] = useState(false);

  const formatDate = (timestamp: number) => {
    return new Date(timestamp).toLocaleDateString("en-AU", {
      day: "numeric",
      month: "short",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  return (
    <div className="bg-white dark:bg-zinc-800 rounded-lg border border-zinc-200 dark:border-zinc-700 overflow-hidden">
      {/* Header - always visible */}
      <button
        onClick={() => setExpanded(!expanded)}
        className="w-full p-4 flex items-center justify-between hover:bg-zinc-50 dark:hover:bg-zinc-700/50 transition-colors"
      >
        <div className="flex items-center gap-4">
          <div className="text-left">
            <div className="flex items-center gap-2">
              <Package className="h-4 w-4 text-zinc-400" />
              <span className="font-mono font-medium text-zinc-900 dark:text-zinc-100">
                {order.orderNumber}
              </span>
            </div>
            <p className="text-sm text-zinc-500 mt-0.5">
              {order.submission?.name || "Unknown"} - {order.design?.productType || "Unknown"}
            </p>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <OrderStatusBadge status={order.status} />
          {expanded ? (
            <ChevronUp className="h-4 w-4 text-zinc-400" />
          ) : (
            <ChevronDown className="h-4 w-4 text-zinc-400" />
          )}
        </div>
      </button>

      {/* Expanded content */}
      {expanded && (
        <div className="px-4 pb-4 border-t border-zinc-100 dark:border-zinc-700">
          {/* Customer info */}
          <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="flex items-start gap-2">
              <User className="h-4 w-4 text-zinc-400 mt-0.5" />
              <div>
                <p className="text-sm font-medium text-zinc-900 dark:text-zinc-100">
                  {order.submission?.name}
                </p>
                <p className="text-sm text-zinc-500">{order.submission?.email}</p>
              </div>
            </div>
            <div className="flex items-start gap-2">
              <Clock className="h-4 w-4 text-zinc-400 mt-0.5" />
              <div>
                <p className="text-sm text-zinc-500">Created</p>
                <p className="text-sm font-medium text-zinc-900 dark:text-zinc-100">
                  {formatDate(order.createdAt)}
                </p>
              </div>
            </div>
          </div>

          {/* Options */}
          {order.submission && (
            <div className="mt-4 flex gap-2">
              {order.submission.siteMeasure && (
                <span className="px-2 py-1 bg-amber-50 text-amber-700 text-xs rounded-full">
                  Site Measure
                </span>
              )}
              {order.submission.installQuote && (
                <span className="px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded-full">
                  Install Quote
                </span>
              )}
            </div>
          )}

          {/* Timeline */}
          {order.timeline && Object.keys(order.timeline).length > 0 && (
            <div className="mt-4">
              <p className="text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
                Timeline
              </p>
              <div className="space-y-1">
                {Object.entries(order.timeline)
                  .filter(([_, timestamp]) => timestamp)
                  .sort(([_, a], [__, b]) => (a as number) - (b as number))
                  .map(([key, timestamp]) => (
                    <div key={key} className="flex justify-between text-sm">
                      <span className="text-zinc-600 dark:text-zinc-400 capitalize">
                        {key.replace(/([A-Z])/g, " $1").trim()}
                      </span>
                      <span className="text-zinc-900 dark:text-zinc-100">
                        {formatDate(timestamp as number)}
                      </span>
                    </div>
                  ))}
              </div>
            </div>
          )}

          {/* Status actions */}
          <div className="mt-4 pt-4 border-t border-zinc-100 dark:border-zinc-700">
            <p className="text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
              Actions
            </p>
            <OrderStatusActions orderId={order._id} currentStatus={order.status} />
          </div>
        </div>
      )}
    </div>
  );
}
```

**src/components/admin/OrderList.tsx:**
```typescript
"use client";

import { useQuery } from "convex/react";
import { api } from "../../../convex/_generated/api";
import { OrderCard } from "./OrderCard";
import { Loader2, Package } from "lucide-react";

export function OrderList() {
  const orders = useQuery(api.orders.listAll);

  if (orders === undefined) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="h-6 w-6 animate-spin text-zinc-400" />
      </div>
    );
  }

  if (orders.length === 0) {
    return (
      <div className="text-center py-12">
        <Package className="h-12 w-12 mx-auto text-zinc-300 dark:text-zinc-600" />
        <h3 className="mt-4 text-lg font-medium text-zinc-900 dark:text-zinc-100">
          No orders yet
        </h3>
        <p className="mt-1 text-sm text-zinc-500">
          Orders will appear here when submissions are converted to orders.
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {orders.map((order) => (
        <OrderCard key={order._id} order={order} />
      ))}
    </div>
  );
}
```
  </action>
  <verify>npm run build passes without errors</verify>
  <done>Order list, card, and status action components created</done>
</task>

<task type="auto">
  <name>Task 3: Create admin orders page</name>
  <files>src/app/admin/orders/page.tsx</files>
  <action>
Create the admin orders page following the submissions page pattern:

**src/app/admin/orders/page.tsx:**
```typescript
"use client";

import { OrderList } from "@/components/admin/OrderList";
import Link from "next/link";

export default function AdminOrdersPage() {
  return (
    <div className="min-h-screen bg-zinc-50 dark:bg-zinc-900">
      <div className="max-w-4xl mx-auto p-6">
        <header className="mb-8">
          <div className="flex items-center gap-2 text-sm text-zinc-500 mb-2">
            <Link href="/admin/submissions" className="hover:text-zinc-700">
              Submissions
            </Link>
            <span>/</span>
            <span className="text-zinc-900 dark:text-zinc-100">Orders</span>
          </div>
          <h1 className="text-2xl font-bold text-zinc-900 dark:text-zinc-50">
            Order Management
          </h1>
          <p className="text-zinc-600 dark:text-zinc-400 mt-1">
            Track orders through production and update status
          </p>
        </header>

        <OrderList />
      </div>
    </div>
  );
}
```

Also add a link from submissions page to orders page:

Update the header in `src/app/admin/submissions/page.tsx` to include navigation link:

```typescript
// Add to the header section after the h1/p:
<div className="mt-4">
  <Link
    href="/admin/orders"
    className="text-sm text-blue-600 hover:text-blue-700"
  >
    View Order Management →
  </Link>
</div>
```

Note: Admin routes remain unprotected for MVP per STATE.md decision.
  </action>
  <verify>Visit /admin/orders in browser shows order list page</verify>
  <done>Admin orders page created with navigation from submissions</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. API working:
   - `useQuery(api.orders.listAll)` returns array of orders with submission/design data
   - `useQuery(api.orders.get, { id })` returns single order with enriched data

2. Components render:
   - OrderList shows loading state, empty state, or list of OrderCards
   - OrderCard expands/collapses with timeline and customer info
   - OrderStatusActions shows valid next status transitions

3. Page accessible:
   - /admin/orders loads without errors
   - Navigation from /admin/submissions works

4. Status workflow:
   - Clicking status action button updates order status
   - Toast shows success/error feedback
   - Timeline updates with new timestamp
</verification>

<success_criteria>
- orders.listAll query returns enriched order data
- orders.get query returns single enriched order by ID
- Admin can view all orders at /admin/orders
- Admin can expand order to see details and timeline
- Admin can update order status through workflow buttons
- Status transitions follow defined workflow (confirmed → production → qc → ready_to_ship → shipped → delivered → complete)
- Notification emails trigger automatically on status change (existing Phase 07 functionality)
</success_criteria>

<output>
After completion, create `.planning/phases/08-production-integration---admin/08-03-SUMMARY.md`
</output>
