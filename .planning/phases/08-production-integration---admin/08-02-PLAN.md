---
phase: 08-production-integration-admin
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/csv/generatePanelCSV.ts
  - src/lib/csv/generateHardwareCSV.ts
  - src/lib/csv/index.ts
  - src/lib/qr/QRLabelSheet.tsx
  - src/lib/qr/index.ts
autonomous: true

must_haves:
  truths:
    - "CSV export generates valid spreadsheet-importable data"
    - "CSV escapes special characters correctly"
    - "QR codes render with error correction level M"
    - "QR label sheet displays panel info below each code"
  artifacts:
    - path: "src/lib/csv/generatePanelCSV.ts"
      provides: "Panel schedule CSV generator"
      exports: ["downloadPanelCSV"]
    - path: "src/lib/csv/generateHardwareCSV.ts"
      provides: "Hardware list CSV generator"
      exports: ["downloadHardwareCSV"]
    - path: "src/lib/qr/QRLabelSheet.tsx"
      provides: "Printable QR label grid"
      exports: ["QRLabelSheet"]
  key_links:
    - from: "src/lib/csv/*.ts"
      to: "react-papaparse"
      via: "jsonToCSV import"
      pattern: "import.*react-papaparse"
    - from: "src/lib/qr/QRLabelSheet.tsx"
      to: "qrcode.react"
      via: "QRCodeSVG import"
      pattern: "import.*qrcode.react"
---

<objective>
Create CSV export utilities and QR label sheet generation for production use.

Purpose: Enable admin to export panel schedules and hardware lists as CSV for spreadsheet import, and generate printable QR label sheets for factory floor use.
Output: CSV download functions and QR label sheet component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-production-integration---admin/08-RESEARCH.md

# Existing panel/order infrastructure
@convex/panels.ts
@convex/orders.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CSV and QR code libraries</name>
  <files>package.json</files>
  <action>
Install the required libraries:

```bash
npm install react-papaparse qrcode.react
```

These libraries:
- react-papaparse: CSV generation with jsonToCSV helper, handles escaping/encoding
- qrcode.react: QR code generation as SVG or Canvas, with error correction levels

IMPORTANT per RESEARCH.md:
- Do NOT hand-roll CSV string concatenation - PapaParse handles edge cases (commas in values, quotes, newlines)
- Use qrcode.react (not react-qr-code) for better error correction options
  </action>
  <verify>npm ls react-papaparse qrcode.react shows both installed</verify>
  <done>Both libraries appear in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create CSV export utilities</name>
  <files>src/lib/csv/generatePanelCSV.ts, src/lib/csv/generateHardwareCSV.ts, src/lib/csv/index.ts</files>
  <action>
Create CSV export functions:

**src/lib/csv/generatePanelCSV.ts:**
```typescript
import { jsonToCSV } from "react-papaparse";
import type { PanelItem } from "../pdf/types";

/**
 * Export panel schedule as CSV
 *
 * IMPORTANT per RESEARCH.md:
 * - Excel can interpret dimensions like "3/4" as dates
 * - Prefix numeric strings with single quote if needed
 * - jsonToCSV handles escaping commas/quotes automatically
 */
export function downloadPanelCSV(panels: PanelItem[], orderNumber: string): void {
  // Flatten to CSV-friendly format
  const data = panels.map((panel, index) => ({
    "Row": index + 1,
    "Panel ID": panel.id,
    "Name": panel.name,
    "Cabinet Ref": panel.cabinetRef,
    "Width (mm)": panel.width,
    "Height (mm)": panel.height,
    "Thickness (mm)": panel.thickness,
    "Material": panel.material,
    "Grain": panel.grainDirection || "N/A",
    "Edge Top": panel.edgeTop ? "Yes" : "No",
    "Edge Bottom": panel.edgeBottom ? "Yes" : "No",
    "Edge Left": panel.edgeLeft ? "Yes" : "No",
    "Edge Right": panel.edgeRight ? "Yes" : "No",
  }));

  const csv = jsonToCSV(data);
  triggerDownload(csv, `${orderNumber}-panel-schedule.csv`);
}

function triggerDownload(content: string, filename: string): void {
  const blob = new Blob([content], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
```

**src/lib/csv/generateHardwareCSV.ts:**
```typescript
import { jsonToCSV } from "react-papaparse";
import type { HardwareItem } from "../pdf/types";

/**
 * Export hardware list (BOM) as CSV
 */
export function downloadHardwareCSV(hardware: HardwareItem[], orderNumber: string): void {
  const data = hardware.map((item, index) => ({
    "Row": index + 1,
    "Code": item.code,
    "Description": item.name,
    "Supplier": item.supplier,
    "Quantity": item.quantity,
    "Unit Price (AUD)": (item.unitPrice / 100).toFixed(2),
    "Total (AUD)": ((item.quantity * item.unitPrice) / 100).toFixed(2),
    "Notes": item.notes || "",
  }));

  // Add total row
  const totalCents = hardware.reduce((sum, item) => sum + item.quantity * item.unitPrice, 0);
  data.push({
    "Row": "",
    "Code": "",
    "Description": "TOTAL",
    "Supplier": "",
    "Quantity": "",
    "Unit Price (AUD)": "",
    "Total (AUD)": (totalCents / 100).toFixed(2),
    "Notes": "",
  } as any);

  const csv = jsonToCSV(data);
  triggerDownload(csv, `${orderNumber}-hardware-list.csv`);
}

function triggerDownload(content: string, filename: string): void {
  const blob = new Blob([content], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
```

**src/lib/csv/index.ts:**
```typescript
export { downloadPanelCSV } from "./generatePanelCSV";
export { downloadHardwareCSV } from "./generateHardwareCSV";
```
  </action>
  <verify>npx tsc --noEmit src/lib/csv/*.ts shows no errors</verify>
  <done>CSV export functions created with proper escaping via react-papaparse</done>
</task>

<task type="auto">
  <name>Task 3: Create QR label sheet component</name>
  <files>src/lib/qr/QRLabelSheet.tsx, src/lib/qr/index.ts</files>
  <action>
Create QR code label sheet for printing:

**src/lib/qr/QRLabelSheet.tsx:**
```typescript
"use client";

import { QRCodeSVG } from "qrcode.react";

export interface PanelLabel {
  panelId: string;
  cabinetRef: string;
  dimensions: string; // "600 x 800 x 18mm"
  material: string;
}

interface QRLabelSheetProps {
  orderId: string;
  orderNumber: string;
  panels: PanelLabel[];
  /** QR code size in pixels (default: 96) */
  qrSize?: number;
}

/**
 * Printable QR label sheet for production floor
 *
 * Each label contains:
 * - QR code linking to /panel/{orderId}-{panelId}
 * - Panel ID
 * - Cabinet reference
 * - Dimensions
 *
 * IMPORTANT per RESEARCH.md:
 * - Use error correction level "M" (15%) minimum for production labels
 * - Keep QR value under 100 chars for reliable scanning
 * - Minimum 96px size for digital, ~25mm for print
 */
export function QRLabelSheet({
  orderId,
  orderNumber,
  panels,
  qrSize = 96,
}: QRLabelSheetProps) {
  // Base URL for panel lookup (public route from Phase 07)
  const baseUrl = typeof window !== "undefined"
    ? `${window.location.origin}/panel`
    : "https://northsouthcarpentry.com/panel";

  return (
    <div className="p-4 bg-white">
      {/* Print header - hidden on screen */}
      <div className="print:block hidden mb-4 text-center">
        <h1 className="text-lg font-bold">North South Carpentry</h1>
        <p className="text-sm text-zinc-600">QR Labels - Order {orderNumber}</p>
      </div>

      {/* Label grid - 4 columns on screen/print */}
      <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 print:grid-cols-4 print:gap-2">
        {panels.map((panel) => {
          // QR code format from STATE.md: {orderId}-{panelId}
          const qrValue = `${baseUrl}/${orderId}-${panel.panelId}`;

          return (
            <div
              key={panel.panelId}
              className="border border-zinc-200 p-3 text-center rounded-lg print:border-black print:rounded-none print:p-2"
            >
              <QRCodeSVG
                value={qrValue}
                size={qrSize}
                level="M" // 15% error correction - handles wear/damage
                marginSize={1}
                className="mx-auto"
              />
              <div className="mt-2 space-y-0.5">
                <p className="text-xs font-mono font-bold text-zinc-900">
                  {panel.panelId}
                </p>
                <p className="text-xs text-zinc-600 truncate">
                  {panel.cabinetRef}
                </p>
                <p className="text-xs text-zinc-500">
                  {panel.dimensions}
                </p>
              </div>
            </div>
          );
        })}
      </div>

      {/* Print footer */}
      <div className="print:block hidden mt-4 text-center text-xs text-zinc-500">
        Scan QR codes to view panel details and assembly instructions
      </div>
    </div>
  );
}

/**
 * Print-specific styles for label sheet
 * Add to global CSS or page-specific stylesheet
 */
export const printStyles = `
@media print {
  @page {
    size: A4;
    margin: 10mm;
  }

  body {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
}
`;
```

**src/lib/qr/index.ts:**
```typescript
export { QRLabelSheet, printStyles } from "./QRLabelSheet";
export type { PanelLabel } from "./QRLabelSheet";
```
  </action>
  <verify>npm run build passes without errors</verify>
  <done>QR label sheet component created with level M error correction</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Libraries installed:
   - `npm ls react-papaparse` shows version
   - `npm ls qrcode.react` shows version

2. CSV functions work:
   - src/lib/csv/generatePanelCSV.ts exports downloadPanelCSV
   - src/lib/csv/generateHardwareCSV.ts exports downloadHardwareCSV

3. QR component works:
   - src/lib/qr/QRLabelSheet.tsx renders QRCodeSVG with level="M"
   - Each label shows panelId, cabinetRef, dimensions

4. Build passes:
   - `npm run build` completes without errors
</verification>

<success_criteria>
- react-papaparse and qrcode.react installed
- downloadPanelCSV generates valid CSV with escaped content
- downloadHardwareCSV generates BOM CSV with totals
- QRLabelSheet renders grid of QR codes with panel info
- QR codes use error correction level M
- Build passes without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-production-integration---admin/08-02-SUMMARY.md`
</output>
