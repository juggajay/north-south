---
phase: 08-production-integration-admin
plan: 04
type: execute
wave: 2
depends_on: ["08-03"]
files_modified:
  - src/components/admin/PhotoUploader.tsx
  - src/components/admin/NotificationTrigger.tsx
  - src/components/admin/OrderCard.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can upload production photos"
    - "Photos are tagged with milestone"
    - "Admin can manually trigger notification emails"
    - "Photo upload shows progress and success feedback"
  artifacts:
    - path: "src/components/admin/PhotoUploader.tsx"
      provides: "Production photo upload component"
      exports: ["PhotoUploader"]
    - path: "src/components/admin/NotificationTrigger.tsx"
      provides: "Manual email trigger component"
      exports: ["NotificationTrigger"]
  key_links:
    - from: "src/components/admin/PhotoUploader.tsx"
      to: "convex/productionPhotos.ts"
      via: "generateUploadUrl + upload mutations"
      pattern: "useMutation\\(api\\.productionPhotos"
    - from: "src/components/admin/NotificationTrigger.tsx"
      to: "convex/notifications"
      via: "scheduled email action"
      pattern: "sendNotificationEmail"
---

<objective>
Add photo upload and notification trigger features to admin order management.

Purpose: Enable admin to upload production photos at each milestone and manually trigger notification emails when needed.
Output: PhotoUploader component for milestone-tagged photo uploads, NotificationTrigger component for manual email sending.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-production-integration---admin/08-RESEARCH.md

# Existing Phase 07 infrastructure
@convex/productionPhotos.ts
@convex/notifications.ts
@convex/notifications/sendEmail.ts

# Admin components from Plan 03
@src/components/admin/OrderCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PhotoUploader component</name>
  <files>src/components/admin/PhotoUploader.tsx</files>
  <action>
Create a photo upload component following the pattern from RESEARCH.md:

**src/components/admin/PhotoUploader.tsx:**
```typescript
"use client";

import { useState, useRef } from "react";
import { useMutation } from "convex/react";
import { api } from "../../../convex/_generated/api";
import type { Id } from "../../../convex/_generated/dataModel";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { Camera, Loader2, Check, X } from "lucide-react";

const MILESTONES = [
  { value: "production", label: "Production" },
  { value: "qc", label: "Quality Control" },
  { value: "packaging", label: "Packaging" },
  { value: "delivery", label: "Delivery" },
] as const;

interface PhotoUploaderProps {
  orderId: Id<"orders">;
}

export function PhotoUploader({ orderId }: PhotoUploaderProps) {
  const [selectedMilestone, setSelectedMilestone] = useState<string>("production");
  const [uploading, setUploading] = useState(false);
  const [preview, setPreview] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const generateUploadUrl = useMutation(api.productionPhotos.generateUploadUrl);
  const uploadPhoto = useMutation(api.productionPhotos.upload);

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith("image/")) {
      toast.error("Please select an image file");
      return;
    }

    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      toast.error("Image must be under 10MB");
      return;
    }

    // Create preview
    const reader = new FileReader();
    reader.onload = () => setPreview(reader.result as string);
    reader.readAsDataURL(file);
  };

  const handleUpload = async () => {
    const file = fileInputRef.current?.files?.[0];
    if (!file) {
      toast.error("Please select a file first");
      return;
    }

    setUploading(true);
    try {
      // 1. Get upload URL from Convex
      const uploadUrl = await generateUploadUrl();

      // 2. Upload file to Convex storage
      const result = await fetch(uploadUrl, {
        method: "POST",
        headers: { "Content-Type": file.type },
        body: file,
      });

      if (!result.ok) {
        throw new Error("Upload failed");
      }

      const { storageId } = await result.json();

      // 3. Save photo record with milestone
      await uploadPhoto({
        orderId,
        storageId,
        milestone: selectedMilestone,
        caption: `${selectedMilestone} photo - ${new Date().toLocaleDateString()}`,
      });

      toast.success("Photo uploaded successfully");

      // Reset form
      setPreview(null);
      if (fileInputRef.current) {
        fileInputRef.current.value = "";
      }
    } catch (error) {
      console.error("Upload error:", error);
      toast.error("Failed to upload photo");
    } finally {
      setUploading(false);
    }
  };

  const handleCancel = () => {
    setPreview(null);
    if (fileInputRef.current) {
      fileInputRef.current.value = "";
    }
  };

  return (
    <div className="space-y-4">
      {/* Milestone selector */}
      <div>
        <label className="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
          Photo Milestone
        </label>
        <div className="flex flex-wrap gap-2">
          {MILESTONES.map((milestone) => (
            <button
              key={milestone.value}
              type="button"
              onClick={() => setSelectedMilestone(milestone.value)}
              className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                selectedMilestone === milestone.value
                  ? "bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900"
                  : "bg-zinc-100 text-zinc-700 hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-300"
              }`}
            >
              {milestone.label}
            </button>
          ))}
        </div>
      </div>

      {/* File input */}
      <div>
        <input
          ref={fileInputRef}
          type="file"
          accept="image/*"
          onChange={handleFileSelect}
          className="hidden"
          id="photo-upload"
        />
        <label
          htmlFor="photo-upload"
          className="flex items-center justify-center gap-2 p-4 border-2 border-dashed border-zinc-300 dark:border-zinc-600 rounded-lg cursor-pointer hover:border-zinc-400 dark:hover:border-zinc-500 transition-colors"
        >
          <Camera className="h-5 w-5 text-zinc-400" />
          <span className="text-sm text-zinc-600 dark:text-zinc-400">
            Click to select photo
          </span>
        </label>
      </div>

      {/* Preview */}
      {preview && (
        <div className="relative">
          <img
            src={preview}
            alt="Preview"
            className="w-full max-h-48 object-cover rounded-lg"
          />
          <button
            onClick={handleCancel}
            className="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600"
          >
            <X className="h-4 w-4" />
          </button>
        </div>
      )}

      {/* Upload button */}
      {preview && (
        <Button
          onClick={handleUpload}
          disabled={uploading}
          className="w-full"
        >
          {uploading ? (
            <>
              <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              Uploading...
            </>
          ) : (
            <>
              <Check className="h-4 w-4 mr-2" />
              Upload Photo
            </>
          )}
        </Button>
      )}
    </div>
  );
}
```

This follows the Convex file upload pattern from RESEARCH.md:
1. Get upload URL from generateUploadUrl mutation
2. POST file directly to storage
3. Save record with storageId
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit src/components/admin/PhotoUploader.tsx</verify>
  <done>PhotoUploader component created with milestone selection and file upload</done>
</task>

<task type="auto">
  <name>Task 2: Create NotificationTrigger component</name>
  <files>src/components/admin/NotificationTrigger.tsx, convex/notifications.ts</files>
  <action>
First, add a manual notification trigger action to convex/notifications.ts:

Add this to convex/notifications.ts:

```typescript
/**
 * Manually trigger a notification email (admin use)
 * This allows re-sending emails or sending custom notifications
 */
export const triggerNotification = internalMutation({
  args: {
    orderId: v.id("orders"),
    type: v.string(),
    to: v.string(),
  },
  handler: async (ctx, args) => {
    // Import the actual send function
    await ctx.scheduler.runAfter(
      0,
      internal.notifications.sendEmail.sendNotificationEmail,
      {
        orderId: args.orderId,
        type: args.type as any,
        to: args.to,
      }
    );
  },
});
```

Also add a public mutation that admin can call:

```typescript
/**
 * Admin action to manually trigger notification
 */
export const adminTriggerNotification = mutation({
  args: {
    orderId: v.id("orders"),
    type: v.string(),
  },
  handler: async (ctx, args) => {
    // Get order to find customer email
    const order = await ctx.db.get(args.orderId);
    if (!order) {
      throw new Error("Order not found");
    }

    const submission = await ctx.db.get(order.submissionId);
    if (!submission || !submission.email) {
      throw new Error("Customer email not found");
    }

    // Validate notification type
    const validTypes = [
      "order_confirmed",
      "production_started",
      "qc_complete",
      "ready_to_ship",
      "delivered",
      "post_install",
    ];
    if (!validTypes.includes(args.type)) {
      throw new Error(`Invalid notification type: ${args.type}`);
    }

    // Schedule email
    await ctx.scheduler.runAfter(
      0,
      internal.notifications.sendEmail.sendNotificationEmail,
      {
        orderId: args.orderId,
        type: args.type as any,
        to: submission.email,
      }
    );

    return { success: true, sentTo: submission.email };
  },
});
```

Then create the UI component:

**src/components/admin/NotificationTrigger.tsx:**
```typescript
"use client";

import { useState } from "react";
import { useMutation } from "convex/react";
import { api } from "../../../convex/_generated/api";
import type { Id } from "../../../convex/_generated/dataModel";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { Mail, Loader2 } from "lucide-react";

const NOTIFICATION_TYPES = [
  { value: "order_confirmed", label: "Order Confirmed" },
  { value: "production_started", label: "Production Started" },
  { value: "qc_complete", label: "QC Complete" },
  { value: "ready_to_ship", label: "Ready to Ship" },
  { value: "delivered", label: "Delivered" },
  { value: "post_install", label: "Post-Install Follow-up" },
] as const;

interface NotificationTriggerProps {
  orderId: Id<"orders">;
  customerEmail?: string;
}

export function NotificationTrigger({ orderId, customerEmail }: NotificationTriggerProps) {
  const [selectedType, setSelectedType] = useState<string>("");
  const [sending, setSending] = useState(false);

  const triggerNotification = useMutation(api.notifications.adminTriggerNotification);

  const handleSend = async () => {
    if (!selectedType) {
      toast.error("Please select a notification type");
      return;
    }

    setSending(true);
    try {
      const result = await triggerNotification({
        orderId,
        type: selectedType,
      });

      toast.success(`Email sent to ${result.sentTo}`);
      setSelectedType("");
    } catch (error) {
      console.error("Send error:", error);
      toast.error("Failed to send notification");
    } finally {
      setSending(false);
    }
  };

  return (
    <div className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
          Send Notification Email
        </label>
        {customerEmail && (
          <p className="text-sm text-zinc-500 mb-2">
            Will send to: {customerEmail}
          </p>
        )}
        <select
          value={selectedType}
          onChange={(e) => setSelectedType(e.target.value)}
          className="w-full px-3 py-2 bg-white dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="">Select notification type...</option>
          {NOTIFICATION_TYPES.map((type) => (
            <option key={type.value} value={type.value}>
              {type.label}
            </option>
          ))}
        </select>
      </div>

      <Button
        onClick={handleSend}
        disabled={!selectedType || sending}
        variant="outline"
        className="w-full"
      >
        {sending ? (
          <>
            <Loader2 className="h-4 w-4 mr-2 animate-spin" />
            Sending...
          </>
        ) : (
          <>
            <Mail className="h-4 w-4 mr-2" />
            Send Email
          </>
        )}
      </Button>

      <p className="text-xs text-zinc-500">
        Note: Emails are sent via Resend. Make sure RESEND_API_KEY is configured.
      </p>
    </div>
  );
}
```
  </action>
  <verify>npm run build passes without errors</verify>
  <done>NotificationTrigger component created with type selection and send functionality</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into OrderCard</name>
  <files>src/components/admin/OrderCard.tsx</files>
  <action>
Update OrderCard to include PhotoUploader and NotificationTrigger components:

Add these imports at the top of src/components/admin/OrderCard.tsx:

```typescript
import { PhotoUploader } from "./PhotoUploader";
import { NotificationTrigger } from "./NotificationTrigger";
```

Add two new collapsible sections in the expanded content area, after the Status actions section:

```typescript
{/* Photo Upload section */}
<div className="mt-4 pt-4 border-t border-zinc-100 dark:border-zinc-700">
  <details className="group">
    <summary className="flex items-center justify-between cursor-pointer list-none">
      <p className="text-sm font-medium text-zinc-700 dark:text-zinc-300">
        Upload Photos
      </p>
      <ChevronDown className="h-4 w-4 text-zinc-400 transition-transform group-open:rotate-180" />
    </summary>
    <div className="mt-4">
      <PhotoUploader orderId={order._id} />
    </div>
  </details>
</div>

{/* Notification Trigger section */}
<div className="mt-4 pt-4 border-t border-zinc-100 dark:border-zinc-700">
  <details className="group">
    <summary className="flex items-center justify-between cursor-pointer list-none">
      <p className="text-sm font-medium text-zinc-700 dark:text-zinc-300">
        Send Notification
      </p>
      <ChevronDown className="h-4 w-4 text-zinc-400 transition-transform group-open:rotate-180" />
    </summary>
    <div className="mt-4">
      <NotificationTrigger
        orderId={order._id}
        customerEmail={order.submission?.email}
      />
    </div>
  </details>
</div>
```

This uses native HTML <details>/<summary> for lightweight collapsible sections without additional state.
  </action>
  <verify>Visit /admin/orders, expand an order, and see Photo Upload and Send Notification sections</verify>
  <done>OrderCard includes PhotoUploader and NotificationTrigger in collapsible sections</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Photo upload working:
   - Select milestone, select file, see preview
   - Click Upload Photo, file uploads to Convex storage
   - Toast shows success message

2. Notification trigger working:
   - Select notification type from dropdown
   - Click Send Email, email is scheduled via Convex
   - Toast shows success with recipient email

3. Integration complete:
   - OrderCard expands to show Photo Upload section
   - OrderCard expands to show Send Notification section
   - Both sections use collapsible <details> for clean UI

4. Build passes:
   - `npm run build` completes without errors
</verification>

<success_criteria>
- Admin can upload photos tagged with milestone (production/qc/packaging/delivery)
- Photos stored in Convex storage with proper records in productionPhotos table
- Admin can manually trigger any of the 6 notification email types
- Notification uses existing Phase 07 email templates
- Both features accessible from expanded OrderCard view
- Build passes without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-production-integration---admin/08-04-SUMMARY.md`
</output>
