---
phase: 02-mobile-ui-shell
plan: 05
type: execute
wave: 2
depends_on: ["02-03"]
files_modified:
  - src/components/chat/ChatMessage.tsx
  - src/components/chat/ChatInput.tsx
  - src/components/chat/ChatInterface.tsx
  - src/app/(tabs)/chat/page.tsx
  - src/components/navigation/BottomNav.tsx
autonomous: true

must_haves:
  truths:
    - "User can type and send a message"
    - "Chat responds with product knowledge within seconds"
    - "Messages persist across page refresh"
    - "Chat shows typing indicator while waiting for response"
    - "Conversation history visible when returning to chat"
    - "Red dot badge appears on Chat tab when unread messages exist"
  artifacts:
    - path: "src/components/chat/ChatMessage.tsx"
      provides: "Individual message bubble component"
      exports: ["ChatMessage"]
    - path: "src/components/chat/ChatInput.tsx"
      provides: "Text input with send button"
      exports: ["ChatInput"]
    - path: "src/components/chat/ChatInterface.tsx"
      provides: "Full chat UI with message list"
      exports: ["ChatInterface"]
    - path: "src/app/(tabs)/chat/page.tsx"
      provides: "Chat tab with real functionality"
      contains: "ChatInterface"
  key_links:
    - from: "src/components/chat/ChatInterface.tsx"
      to: "convex/chat.ts"
      via: "useAction and useQuery hooks"
      pattern: "useAction\\(api\\.chat"
    - from: "src/components/navigation/BottomNav.tsx"
      to: "convex/chat.ts"
      via: "useQuery for unread count"
      pattern: "getUnreadCount"
---

<objective>
Implement the chat UI that connects to the Gemini-powered backend for product knowledge Q&A.

Purpose: Give customers instant answers about materials, hardware, and joinery options through a friendly AI assistant with tradesperson personality.

Output: Complete chat interface with real-time messaging, conversation persistence, and unread badge indicator.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mobile-ui-shell/02-CONTEXT.md
@.planning/phases/02-mobile-ui-shell/02-03-SUMMARY.md
@convex/chat.ts
@src/components/navigation/BottomNav.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChatMessage and ChatInput components</name>
  <files>src/components/chat/ChatMessage.tsx, src/components/chat/ChatInput.tsx</files>
  <action>
    Create src/components/chat/ChatMessage.tsx:
    - Props: role ("user" | "assistant"), content, timestamp
    - User messages: right-aligned, zinc-900 background, white text
    - Assistant messages: left-aligned, zinc-100 background, zinc-900 text
    - Rounded corners (rounded-2xl), different corner radius for sender side
    - Max width 80% of container
    - Timestamp in small muted text below bubble
    - Smooth appear animation with Framer Motion (fadeIn + slideUp)

    Create TypingIndicator component (can be in same file or separate):
    - Three dots animation (bouncing dots)
    - Shows when waiting for AI response
    - Same styling as assistant message bubble

    Create src/components/chat/ChatInput.tsx:
    - Full-width input with send button
    - Props: onSend, disabled, placeholder
    - Input styled with zinc-100 background, rounded-full
    - Send button: circular, zinc-900 background, arrow icon
    - Send button disabled state when input empty or disabled prop true
    - Submit on Enter key (not shift+enter for multiline)
    - Minimum height 48px for touch target
    - Auto-focus on mount
    - Clear input after send
    - Positioned at bottom of chat, above safe area
  </action>
  <verify>
    - ChatMessage renders correctly for both roles
    - User messages right-aligned with dark background
    - Assistant messages left-aligned with light background
    - TypingIndicator shows animated dots
    - ChatInput has working send button
    - Enter key submits message
    - Input clears after send
  </verify>
  <done>
    ChatMessage component renders user/assistant messages with proper styling. ChatInput provides text entry with send functionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ChatInterface and integrate with Chat page</name>
  <files>src/components/chat/ChatInterface.tsx, src/app/(tabs)/chat/page.tsx</files>
  <action>
    Create src/components/chat/ChatInterface.tsx:
    - Full height container (flex flex-col h-full)
    - Header: "AI Assistant" title, optional conversation info
    - Message list: scrollable area, messages rendered with ChatMessage
    - Auto-scroll to bottom on new messages (useEffect with ref)
    - TypingIndicator shown when waiting for response
    - ChatInput fixed at bottom
    - State management:
      - conversationId: stored in localStorage for persistence
      - messages: from Convex query
      - isLoading: while sending message
    - Convex integration:
      - useQuery(api.chat.getConversation, { conversationId }) for messages
      - useAction(api.chat.sendMessage) for sending
      - Handle first message creating new conversation
    - Empty state: "Ask me anything about materials, hardware, or cabinetry."
    - Error handling: show error message if Gemini fails, allow retry

    Update src/app/(tabs)/chat/page.tsx:
    - Replace placeholder with ChatInterface
    - Full height layout (h-screen minus bottom nav)
    - Proper padding for safe areas (pb-20 for bottom nav)
    - Mark conversation as read when page mounts (call markAsRead mutation)

    Initial assistant message on new conversation:
    - Don't auto-send a greeting - let user initiate
    - Empty state message serves as the greeting
  </action>
  <verify>
    - Visit http://localhost:3000/chat
    - Empty state message visible
    - Type and send a message about materials
    - TypingIndicator shows while waiting
    - Response appears with tradesperson personality
    - Messages persist on page refresh
    - Auto-scroll works on new messages
    - Error state appears if API fails (test by disconnecting network)
  </verify>
  <done>
    ChatInterface provides complete chat experience with Convex backend. Messages persist, typing indicators work, and conversation flows naturally.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up unread badge to BottomNav</name>
  <files>src/components/navigation/BottomNav.tsx</files>
  <action>
    Update BottomNav.tsx to show real unread count:

    - Import useQuery from convex/react
    - Import api from convex/_generated/api
    - Query unread count: useQuery(api.chat.getUnreadCount)
    - Pass unreadCount to TabBadge for Chat tab
    - Show red dot (showDot) when unreadCount > 0
    - Badge should update reactively when new messages arrive

    Handle loading/undefined state gracefully:
    - Don't show badge while query is loading
    - Only show when we have confirmed unread count > 0

    Note: Since user is viewing the chat page, the count should be 0.
    Badge appears when user is on OTHER tabs and a message comes in.
    This requires the assistant response to increment unreadCount.
    Verify convex/chat.ts increments unreadCount on assistant message.

    Test scenario:
    1. Start on Home tab
    2. Send message via Convex dashboard (simulate incoming)
    3. Badge should appear on Chat tab
    4. Navigate to Chat tab
    5. Badge should disappear (markAsRead called)
  </action>
  <verify>
    - BottomNav queries unread count from Convex
    - Red dot appears when unreadCount > 0
    - Dot disappears when navigating to Chat (markAsRead)
    - No badge shown while loading or when count is 0
    - Real-time updates work (Convex reactivity)
  </verify>
  <done>
    Chat tab shows red dot badge for unread messages. Badge clears when user views chat.
  </done>
</task>

</tasks>

<verification>
- Chat components in src/components/chat/
- Chat page replaced with functional ChatInterface
- Messages round-trip to Gemini and back
- Tradesperson personality evident in responses
- Off-topic questions get boundary response
- Conversation persists across page refresh
- Typing indicator during AI response
- Unread badge on Chat tab when not viewing chat
- Badge clears when viewing chat
- `npm run build` succeeds
</verification>

<success_criteria>
- User can have product knowledge conversation
- Gemini responses match tradesperson personality
- Off-topic questions handled with boundary message
- Messages persist in Convex
- Real-time unread badge working
- Smooth typing experience with indicators
- Mobile-friendly layout with proper safe areas
</success_criteria>

<output>
After completion, create `.planning/phases/02-mobile-ui-shell/02-05-SUMMARY.md`
</output>
