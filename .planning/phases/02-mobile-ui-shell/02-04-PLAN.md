---
phase: 02-mobile-ui-shell
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/camera/CaptureButton.tsx
  - src/components/camera/GuidanceOverlay.tsx
  - src/components/camera/PhotoPreview.tsx
  - src/components/camera/CameraCapture.tsx
  - src/lib/camera.ts
  - src/app/(tabs)/page.tsx
autonomous: true

must_haves:
  truths:
    - "Camera opens full-screen when user taps Take Photo"
    - "Corner bracket guidance overlay visible during capture"
    - "Rotating tips display at bottom of camera view"
    - "Press-and-hold 1 second required to capture photo"
    - "Photo preview shows after capture with Use/Retake options"
    - "Blurry photos rejected with specific guidance message"
    - "Dark photos rejected with specific guidance message"
    - "User can select from gallery as alternative"
  artifacts:
    - path: "src/components/camera/CaptureButton.tsx"
      provides: "Press-and-hold shutter button with progress ring"
      exports: ["CaptureButton"]
    - path: "src/components/camera/GuidanceOverlay.tsx"
      provides: "Corner brackets and rotating tips"
      exports: ["GuidanceOverlay"]
    - path: "src/components/camera/PhotoPreview.tsx"
      provides: "Preview screen with quality validation"
      exports: ["PhotoPreview"]
    - path: "src/components/camera/CameraCapture.tsx"
      provides: "Full camera capture interface"
      exports: ["CameraCapture"]
    - path: "src/lib/camera.ts"
      provides: "Capacitor camera wrapper"
      exports: ["capturePhoto", "selectFromGallery"]
  key_links:
    - from: "src/components/camera/PhotoPreview.tsx"
      to: "src/lib/image-quality.ts"
      via: "validateImageQuality import"
      pattern: "import.*validateImageQuality"
    - from: "src/components/camera/CameraCapture.tsx"
      to: "@capacitor/camera"
      via: "Capacitor Camera plugin"
      pattern: "Camera\\.getPhoto"
    - from: "src/app/(tabs)/page.tsx"
      to: "src/components/camera/CameraCapture.tsx"
      via: "component import and state"
      pattern: "import.*CameraCapture"
---

<objective>
Implement the full camera capture interface with guidance overlay, press-and-hold shutter, and image quality validation.

Purpose: Create the primary entry point for the app - photographing a space. The capture flow must feel premium with guidance overlays and prevent users from submitting poor quality photos.

Output: Complete camera capture flow from opening camera to validated photo ready for AI processing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mobile-ui-shell/02-CONTEXT.md
@.planning/phases/02-mobile-ui-shell/02-RESEARCH.md
@.planning/phases/02-mobile-ui-shell/02-01-SUMMARY.md
@src/lib/image-quality.ts
@src/app/(tabs)/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Capacitor camera wrapper and CaptureButton</name>
  <files>src/lib/camera.ts, src/components/camera/CaptureButton.tsx</files>
  <action>
    Create src/lib/camera.ts - Capacitor camera wrapper:
    ```typescript
    import { Camera, CameraResultType, CameraSource } from "@capacitor/camera";

    export async function capturePhoto(): Promise<string> {
      const image = await Camera.getPhoto({
        quality: 90,
        allowEditing: false,
        resultType: CameraResultType.Uri,
        source: CameraSource.Camera,
        correctOrientation: true,
        width: 2048,
        height: 2048,
      });
      return image.webPath!;
    }

    export async function selectFromGallery(): Promise<string> {
      const image = await Camera.getPhoto({
        quality: 90,
        allowEditing: false,
        resultType: CameraResultType.Uri,
        source: CameraSource.Photos,
        correctOrientation: true,
      });
      return image.webPath!;
    }

    export async function checkCameraPermission(): Promise<boolean> {
      const status = await Camera.checkPermissions();
      if (status.camera === "granted") return true;
      const request = await Camera.requestPermissions();
      return request.camera === "granted";
    }
    ```

    Create src/components/camera/CaptureButton.tsx - Press-and-hold shutter:
    - Use Framer Motion for gestures (onTapStart, onTap, onTapCancel)
    - 1 second hold duration to capture
    - Visual progress ring using SVG circle with animated strokeDashoffset
    - Ring animates from 0 to full as user holds
    - If released early, ring resets (no capture)
    - If held full duration, onCapture callback fires
    - 80x80px button size for thumb zone
    - White inner circle, zinc-900 progress ring
    - Add touch-action: none CSS to prevent scroll interference

    From RESEARCH.md pattern - use useMotionValue and animate for smooth progress.
  </action>
  <verify>
    - src/lib/camera.ts exports capturePhoto, selectFromGallery, checkCameraPermission
    - CaptureButton renders with white circle
    - Test in isolation: import into a test page, hold for 1 second, console.log fires
    - Release before 1 second: no capture, ring resets
  </verify>
  <done>
    Capacitor camera wrapper ready. CaptureButton implements press-and-hold gesture with visual progress ring.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GuidanceOverlay and PhotoPreview components</name>
  <files>src/components/camera/GuidanceOverlay.tsx, src/components/camera/PhotoPreview.tsx</files>
  <action>
    Create src/components/camera/GuidanceOverlay.tsx:
    - Corner brackets framing the capture area (4 L-shaped corners)
    - Brackets positioned with padding from edges (e.g., 16px)
    - White/semi-transparent stroke, 3px width
    - Rotating tips at bottom that cycle every 4 seconds:
      1. "Stand back to capture the full wall"
      2. "Include floor and ceiling if possible"
      3. "Ensure good lighting for best results"
      4. "Hold steady while capturing"
    - Tips in white text with subtle background blur
    - Use useState + useEffect with setInterval for rotation
    - Gallery button in bottom-left corner (Image icon)

    Create src/components/camera/PhotoPreview.tsx:
    - Full-screen image preview
    - Quality validation runs immediately on mount (use validateImageQuality from 02-01)
    - Show loading state: "Checking quality..."
    - If valid:
      - Green checkmark badge
      - "Photo looks great!"
      - Two buttons: "Use Photo" (primary), "Retake" (secondary/ghost)
    - If invalid:
      - Red alert icon
      - List all issues from validation (technical tone with tips per CONTEXT.md)
      - Single button: "Retake" (no option to proceed - strict rejection per CONTEXT.md)
    - Props: imageUrl, onUsePhoto, onRetake
    - Use proper loading states during async validation

    Both components should be full-screen overlays (fixed inset-0).
  </action>
  <verify>
    - GuidanceOverlay renders corner brackets
    - Tips rotate every 4 seconds
    - Gallery button visible in bottom-left
    - PhotoPreview shows loading state, then result
    - Test with a blurry image URL: rejection message displays
    - "Retake" button functional
  </verify>
  <done>
    GuidanceOverlay shows corner brackets and rotating tips. PhotoPreview validates quality and enforces strict rejection for poor images.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CameraCapture and integrate with Home page</name>
  <files>src/components/camera/CameraCapture.tsx, src/app/(tabs)/page.tsx</files>
  <action>
    Create src/components/camera/CameraCapture.tsx - Full camera interface:
    - Props: open, onClose, onPhotoAccepted
    - State machine: "camera" | "preview" | "closed"
    - Camera state:
      - Full-screen dark background
      - GuidanceOverlay rendered on top
      - CaptureButton centered in bottom thumb zone
      - Gallery button (from GuidanceOverlay) triggers selectFromGallery
      - Close/X button in top-left corner
    - On capture complete:
      - Call capturePhoto() from camera.ts
      - Transition to "preview" state
    - On gallery select:
      - Call selectFromGallery() from camera.ts
      - Transition to "preview" state
    - Preview state:
      - Render PhotoPreview with captured imageUrl
      - onUsePhoto: call onPhotoAccepted(imageUrl), transition to closed
      - onRetake: transition back to "camera"
    - Handle Capacitor permission check on open
    - Show permission denied message if camera blocked

    Note: In web browser, Capacitor Camera will use native file picker or getUserMedia fallback.
    For true native camera, must test on iOS/Android simulator or device.

    Update src/app/(tabs)/page.tsx:
    - Add state: const [cameraOpen, setCameraOpen] = useState(false)
    - "Take Photo" button onClick: setCameraOpen(true)
    - Add "Browse Gallery" text button below that also triggers camera with gallery source
    - Render CameraCapture when open
    - onPhotoAccepted handler: for now, console.log the imageUrl and close
      (Photo processing pipeline comes in Phase 03)
    - Import CameraCapture component

    AnimatePresence for smooth open/close transitions.
  </action>
  <verify>
    - Visit http://localhost:3000/
    - Click "Take Photo" - camera UI opens
    - Corner brackets and tips visible
    - Hold capture button - progress ring animates
    - Complete hold - photo captured (or native picker on web)
    - Preview shows with quality check
    - "Use Photo" returns to home (with console.log)
    - "Retake" returns to camera view
    - X button closes camera
    - Gallery button opens photo picker
  </verify>
  <done>
    Complete camera capture flow working from Home tab. User can capture or select photo, see quality validation, and proceed or retake.
  </done>
</task>

</tasks>

<verification>
- All camera components in src/components/camera/
- CaptureButton requires 1 second hold
- GuidanceOverlay shows brackets + rotating tips
- PhotoPreview validates quality with strict rejection
- CameraCapture integrates all components
- Home page "Take Photo" opens camera
- Full flow: Open -> Capture -> Preview -> Use/Retake
- Poor quality images cannot proceed (strict rejection)
- `npm run build` succeeds
</verification>

<success_criteria>
- Camera opens as primary entry point from Home
- User guided with corner brackets and tips during capture
- Press-and-hold prevents accidental captures
- Quality validation catches blur and lighting issues
- Technical tone messages with actionable tips
- Strict rejection - no way to proceed with bad photos
- Flow feels premium and intentional
</success_criteria>

<output>
After completion, create `.planning/phases/02-mobile-ui-shell/02-04-SUMMARY.md`
</output>
