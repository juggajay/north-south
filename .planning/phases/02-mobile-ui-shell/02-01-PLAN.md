---
phase: 02-mobile-ui-shell
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/image-quality.ts
  - src/lib/image-quality.test.ts
autonomous: true

must_haves:
  truths:
    - "Blur detection returns variance below threshold for blurry images"
    - "Blur detection returns variance above threshold for sharp images"
    - "Brightness detection identifies underexposed images"
    - "Brightness detection identifies overexposed images"
    - "Combined validation returns specific issue messages"
  artifacts:
    - path: "src/lib/image-quality.ts"
      provides: "Image quality detection utilities"
      exports: ["detectBlur", "detectBrightness", "validateImageQuality"]
    - path: "src/lib/image-quality.test.ts"
      provides: "Unit tests for image quality detection"
      min_lines: 50
  key_links:
    - from: "src/lib/image-quality.ts"
      to: "Canvas API"
      via: "ImageData processing"
      pattern: "getImageData"
---

<objective>
TDD implementation of client-side image quality detection utilities for camera capture validation.

Purpose: Enable immediate feedback on photo quality after capture, rejecting blurry or poorly-lit images before they waste user time in the AI pipeline.

Output: Tested utility functions for blur detection (Laplacian variance) and brightness analysis (pixel averaging) that the camera capture flow will use.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mobile-ui-shell/02-RESEARCH.md
</context>

<feature>
  <name>Image Quality Detection</name>
  <files>src/lib/image-quality.ts, src/lib/image-quality.test.ts</files>
  <behavior>
    Blur detection using Laplacian variance:
    - Input: ImageData from canvas
    - Output: variance number (higher = sharper)
    - Threshold: ~100 (below = blurry)

    Brightness detection using pixel averaging:
    - Input: ImageData from canvas
    - Output: brightness 0-255
    - Thresholds: <50 = underexposed, >220 = overexposed

    Combined validation:
    - Input: image URL (string)
    - Output: { valid: boolean, issues: string[] }
    - Issues format: "Image sharpness: Low. Tip: ..."

    Cases:
    - detectBlur(blurryImageData) → variance < 100
    - detectBlur(sharpImageData) → variance >= 100
    - detectBrightness(darkImageData) → brightness < 50
    - detectBrightness(brightImageData) → brightness > 220
    - detectBrightness(normalImageData) → 50 <= brightness <= 220
    - validateImageQuality(blurryUrl) → { valid: false, issues: ["Image sharpness: Low..."] }
    - validateImageQuality(darkUrl) → { valid: false, issues: ["Image brightness: Low..."] }
    - validateImageQuality(goodUrl) → { valid: true, issues: [] }
  </behavior>
  <implementation>
    Follow research patterns from 02-RESEARCH.md:

    1. detectBlur(imageData: ImageData): number
       - Convert RGBA to grayscale using luminosity formula (0.299*R + 0.587*G + 0.114*B)
       - Apply 3x3 Laplacian kernel: [0,1,0], [1,-4,1], [0,1,0]
       - Calculate variance of Laplacian values
       - Return variance (higher = sharper)

    2. detectBrightness(imageData: ImageData): number
       - Average RGB values across all pixels
       - Return average brightness (0-255)

    3. getBrightnessIssue(brightness: number): string | null
       - Return specific message for under/overexposed

    4. isBlurry(variance: number, threshold?: number): boolean
       - Default threshold: 100

    5. validateImageQuality(imageUrl: string): Promise<{ valid: boolean, issues: string[] }>
       - Load image from URL
       - Create canvas, downscale to 1024px max dimension for performance
       - Get ImageData
       - Run both detections
       - Compile issues array with user-friendly messages

    Issue messages (from CONTEXT.md - technical tone with tips):
    - Blur: "Image sharpness: Low. Tip: Ensure good lighting and hold phone steady."
    - Dark: "Image brightness: Low. Tip: Move to a well-lit area or turn on lights."
    - Bright: "Image brightness: High. Tip: Avoid direct sunlight or bright lights in frame."
  </implementation>
</feature>

<verification>
- `npm test src/lib/image-quality.test.ts` passes
- All test cases cover blur detection threshold behavior
- All test cases cover brightness detection edge cases
- Combined validation returns properly formatted messages
</verification>

<success_criteria>
- RED: Tests written and failing
- GREEN: Implementation passes all tests
- REFACTOR: Code cleaned up if needed
- All exports typed correctly
- No external dependencies (Canvas API only)
</success_criteria>

<output>
After completion, create `.planning/phases/02-mobile-ui-shell/02-01-SUMMARY.md`
</output>
