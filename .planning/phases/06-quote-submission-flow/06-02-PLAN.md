---
phase: 06-quote-submission-flow
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/submission/PreSubmitOptions.tsx
  - src/components/submission/ReviewSummary.tsx
  - src/components/submission/ConfirmationScreen.tsx
  - src/components/submission/SubmissionFlow.tsx
  - src/components/wizard/StepReview.tsx
  - src/components/wizard/StepNavigation.tsx
autonomous: true

must_haves:
  truths:
    - "User sees site measure toggle with explanation text"
    - "User sees installation quote toggle with explanation text"
    - "User sees optional notes textarea"
    - "User sees review summary showing config + selected options"
    - "User can submit and sees confirmation with 2-3 day timeline"
    - "User sees message clarifying no confirmation email will be sent"
    - "User is auto-redirected to Orders tab after submission"
  artifacts:
    - path: "src/components/submission/PreSubmitOptions.tsx"
      provides: "Toggle UI for site measure and installation options"
      min_lines: 50
    - path: "src/components/submission/ReviewSummary.tsx"
      provides: "Final review before submit showing all choices"
      min_lines: 80
    - path: "src/components/submission/ConfirmationScreen.tsx"
      provides: "Success message with timeline, no-email note, and auto-redirect"
      min_lines: 40
    - path: "src/components/submission/SubmissionFlow.tsx"
      provides: "Multi-step flow orchestration"
      min_lines: 60
  key_links:
    - from: "src/components/submission/SubmissionFlow.tsx"
      to: "convex/submissions.ts"
      via: "useMutation(api.submissions.create)"
      pattern: "useMutation.*submissions\\.create"
    - from: "src/components/wizard/StepNavigation.tsx"
      to: "src/components/submission/SubmissionFlow.tsx"
      via: "Submit button triggers submission flow"
      pattern: "SubmissionFlow|onSubmit"
---

<objective>
Build the customer-facing submission flow that appears after completing the wizard.

Purpose: When user finishes configuring their design in Step 4 (Review), they need a way to submit for a quote. This plan creates the pre-submit options (site measure, installation), review summary, and confirmation screen with auto-redirect.

Output: Complete submission flow components wired to StepReview, using React Hook Form + Zod for the form, Convex mutation for submission.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-quote-submission-flow/06-CONTEXT.md
@.planning/phases/06-quote-submission-flow/06-RESEARCH.md
@.planning/phases/06-quote-submission-flow/06-01-SUMMARY.md
@src/components/wizard/StepReview.tsx
@src/components/wizard/StepNavigation.tsx
@src/hooks/useAuth.ts
@src/stores/useCabinetStore.ts
@convex/submissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create submission flow components</name>
  <files>
src/components/submission/PreSubmitOptions.tsx
src/components/submission/ReviewSummary.tsx
src/components/submission/ConfirmationScreen.tsx
src/components/submission/SubmissionFlow.tsx
  </files>
  <action>
Create 4 components in `src/components/submission/`:

**1. PreSubmitOptions.tsx** - Toggles for site measure and installation quote
```typescript
"use client";

import { UseFormReturn } from "react-hook-form";
import { FormField, FormItem, FormLabel, FormControl, FormDescription } from "@/components/ui/form";
import { Switch } from "@/components/ui/switch";
import { Textarea } from "@/components/ui/textarea";

interface PreSubmitOptionsProps {
  form: UseFormReturn<SubmissionFormData>;
}

// Include:
// - siteMeasure toggle with label "Professional site measure" and description "Team will include pricing in your quote"
// - installQuote toggle with same pattern
// - notes textarea with label "Anything else we should know?" and placeholder about access issues, timeline, special requirements
//
// IMPORTANT: NO name/email fields here - user is logged in, use account data automatically
```

**2. ReviewSummary.tsx** - Shows config summary + selected options before final submit
```typescript
"use client";

import { useCabinetStore } from "@/stores/useCabinetStore";
import { usePricing } from "@/hooks/usePricing";

interface ReviewSummaryProps {
  siteMeasure: boolean;
  installQuote: boolean;
  notes: string;
  onBack: () => void;
  onSubmit: () => void;
  isSubmitting: boolean;
}

// Include:
// - Config summary (dimensions, module count, finishes) - reuse pattern from StepReview
// - Price estimate from usePricing hook
// - Selected options display (site measure yes/no, installation yes/no)
// - Customer notes if provided
// - Back button (to change options)
// - Submit for Quote button (primary, disabled during submission)
//
// NO name/email display needed - user knows who they are
```

**3. ConfirmationScreen.tsx** - Success message with auto-redirect
```typescript
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { CheckCircle, Info } from "lucide-react";

interface ConfirmationScreenProps {
  submissionId: string;
}

// Include:
// - Success icon (CheckCircle from lucide-react)
// - "Quote request submitted!" heading
// - "We'll email you when your quote is ready (2-3 business days)" message
// - CRITICAL: Add note clarifying no confirmation email:
//   "No confirmation email will be sent now. You'll hear from us when your quote is ready."
//   (Use Info icon + muted text styling)
// - Brief summary card (optional: design thumbnail if renders exist)
// - Auto-redirect to /orders after 2.5 seconds using useEffect + setTimeout
// - Cleanup timeout on unmount (return () => clearTimeout)
```

**4. SubmissionFlow.tsx** - Orchestrates the multi-step flow
```typescript
"use client";

import { useState, useEffect } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useMutation } from "convex/react";
import { api } from "../../../convex/_generated/api";
import { useAuth } from "@/hooks/useAuth";
import { useCabinetStore } from "@/stores/useCabinetStore";
import { toast } from "sonner";
import { Form } from "@/components/ui/form";

// IMPORTANT: Schema only has siteMeasure, installQuote, notes
// NO name/email fields - these come from useAuth() automatically
const submissionSchema = z.object({
  siteMeasure: z.boolean(),
  installQuote: z.boolean(),
  notes: z.string().optional(),
});

type SubmissionFormData = z.infer<typeof submissionSchema>;

interface SubmissionFlowProps {
  designId: string;  // REQUIRED - passed from existing auto-saved design
  onCancel: () => void;
}

// State machine: "options" -> "review" -> "confirmation"
// - "options": Show PreSubmitOptions
// - "review": Show ReviewSummary with form.watch() values
// - "confirmation": Show ConfirmationScreen

// On submit:
// 1. Get user from useAuth() - MUST have user.name and user.email
// 2. Get config from useCabinetStore
// 3. Call submissions.create mutation with:
//    - designId (passed in as prop - from existing auto-saved design)
//    - name: user.name (auto-populated from logged-in account)
//    - email: user.email (auto-populated from logged-in account)
//    - siteMeasure, installQuote, notes from form
// 4. On success: transition to "confirmation" step, show toast
// 5. On error: show error toast, stay on review step
```

Define the Zod schema and form types in SubmissionFlow.tsx (no separate schema file needed for this simple form).
  </action>
  <verify>
1. Run `npm run typecheck` - no TypeScript errors
2. Files exist: `ls src/components/submission/`
3. Each component exports a named function
4. Verify submissionSchema does NOT contain name or email fields
5. Verify ConfirmationScreen contains no-email messaging
  </verify>
  <done>
- PreSubmitOptions shows toggles for site measure and installation (NO name/email fields)
- ReviewSummary displays config + options with Back/Submit buttons
- ConfirmationScreen shows success with timeline, no-email note, and auto-redirect
- SubmissionFlow orchestrates the 3-step flow, auto-populates name/email from useAuth()
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire submission flow to wizard</name>
  <files>
src/components/wizard/StepReview.tsx
src/components/wizard/StepNavigation.tsx
  </files>
  <action>
Integrate the submission flow into the existing wizard:

**1. Update StepReview.tsx:**
- Remove the placeholder "Submit for Quote will be enabled soon" text
- Add state: `const [showSubmission, setShowSubmission] = useState(false)`
- Add a "Submit for Quote" button that sets showSubmission to true
- When showSubmission is true, render SubmissionFlow component instead of the review content
- Pass existing auto-saved designId to SubmissionFlow (see below for how to get it)

**2. Update StepNavigation.tsx:**
- On step 3 (Review), change the "Next" button to "Submit for Quote" or hide it
- OR: Keep navigation simple and let the submit button live in StepReview

**Design decision (from CONTEXT.md - LOCKED):**
- User is already logged in (auth required)
- Design is ALREADY auto-saved from Phase 04 - DO NOT create new design
- No extra draft logic needed

**Getting the existing designId:**
The design was auto-saved in Phase 04. Check for:
1. A `currentDesignId` in useCabinetStore or a design context
2. If using URL-based design IDs: extract from route params
3. If stored in session/local state: retrieve from there

IMPORTANT: DO NOT create a new design on submission. The design already exists from auto-save.
Only create a new design as a fallback if somehow no saved design exists (edge case).

**Implementation:**
```typescript
// In StepReview.tsx
const [showSubmission, setShowSubmission] = useState(false);
const { user } = useAuth();

// Get existing auto-saved designId from wherever Phase 04 stores it
// This might be in:
// - useCabinetStore state (e.g., store.currentDesignId)
// - URL params (e.g., useParams().designId)
// - A separate design context
const designId = /* get from existing auto-save location */;

const handleStartSubmission = () => {
  if (!designId) {
    toast.error("No saved design found. Please save your design first.");
    return;
  }
  setShowSubmission(true);
};

// Render SubmissionFlow when showSubmission is true
{showSubmission && designId ? (
  <SubmissionFlow
    designId={designId}
    onCancel={() => setShowSubmission(false)}
  />
) : (
  // Normal review content with Submit button
)}
```
  </action>
  <verify>
1. Run `npm run typecheck` - no TypeScript errors
2. Run `npm run dev` - app starts without errors
3. Navigate to wizard Step 4 - see "Submit for Quote" button
4. Click button - submission flow appears with options (no name/email fields)
5. Verify designId comes from existing auto-save, not created on-the-fly
  </verify>
  <done>
- StepReview shows "Submit for Quote" button
- Clicking button shows SubmissionFlow with existing auto-saved designId
- SubmissionFlow integrated with options -> review -> confirmation steps
- Submission uses name/email from logged-in account automatically
- No duplicate design creation - uses existing auto-saved design
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npm run typecheck` passes
2. Dev server: `npm run dev` works without errors
3. Manual test flow:
   - Go to wizard, complete steps 1-3
   - On Step 4 (Review), click "Submit for Quote"
   - See pre-submit options (toggles for site measure/install, notes textarea)
   - Verify NO name/email form fields (should auto-use logged-in account)
   - Proceed to review summary
   - Click Submit
   - See confirmation with success message AND no-email clarification
   - Auto-redirect to Orders tab after ~2.5 seconds
4. Check Convex dashboard: new submission record created with correct user name/email
</verification>

<success_criteria>
- User can see and toggle site measure option
- User can see and toggle installation quote option
- User can add optional notes
- User is NOT asked for name/email (auto-populated from account)
- User sees review summary before final submit
- Submit creates submission in Convex with correct data (including auto-populated name/email)
- Confirmation screen shows success message, timeline, AND no-email clarification
- Auto-redirect to Orders tab works
- Submission uses existing auto-saved designId (no duplicate design creation)
</success_criteria>

<output>
After completion, create `.planning/phases/06-quote-submission-flow/06-02-SUMMARY.md`
</output>
