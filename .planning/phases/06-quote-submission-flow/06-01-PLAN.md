---
phase: 06-quote-submission-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/submissions.ts
autonomous: true

must_haves:
  truths:
    - "Submission can store internal notes separate from customer notes"
    - "Submissions can be filtered by multiple statuses"
    - "Team can query all submissions with full design data"
  artifacts:
    - path: "convex/schema.ts"
      provides: "internalNotes field on submissions table"
      contains: "internalNotes"
    - path: "convex/submissions.ts"
      provides: "listAll query for team dashboard"
      exports: ["listAll", "updateInternalNotes"]
  key_links:
    - from: "convex/submissions.ts"
      to: "convex/schema.ts"
      via: "schema definition"
      pattern: "submissions.*internalNotes"
---

<objective>
Extend Convex schema and submissions API to support internal team workflows.

Purpose: The existing submissions.ts has basic CRUD but lacks: (1) internal notes field for team-only context, (2) a query for listing ALL submissions regardless of status, (3) mutation for updating internal notes. These are required before building the team dashboard.

Output: Updated schema with internalNotes field, new listAll query, updateInternalNotes mutation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-quote-submission-flow/06-CONTEXT.md
@.planning/phases/06-quote-submission-flow/06-RESEARCH.md
@convex/schema.ts
@convex/submissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add internalNotes field to submissions schema</name>
  <files>convex/schema.ts</files>
  <action>
Add `internalNotes` field to the submissions table definition:

1. Locate the submissions table in schema.ts (around line 51-65)
2. Add after the existing `notes` field:
   ```typescript
   internalNotes: v.optional(v.string()), // Team-only notes, not visible to customer
   ```

This keeps customer notes (`notes`) separate from internal team context (`internalNotes`).
  </action>
  <verify>
Run `npx convex dev` - schema should push without errors. Check Convex dashboard shows `internalNotes` field on submissions table.
  </verify>
  <done>
Submissions table has both `notes` (customer) and `internalNotes` (team) fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add listAll query and updateInternalNotes mutation</name>
  <files>convex/submissions.ts</files>
  <action>
Add two new exports to submissions.ts:

1. `listAll` query - Returns all submissions (not just pending) with design data, ordered by createdAt desc, limited to 100. Used by team dashboard.
   ```typescript
   export const listAll = query({
     args: {},
     handler: async (ctx) => {
       const submissions = await ctx.db
         .query("submissions")
         .order("desc")
         .take(100);

       const enriched = await Promise.all(
         submissions.map(async (submission) => {
           const design = await ctx.db.get(submission.designId);
           return { ...submission, design };
         })
       );

       return enriched;
     },
   });
   ```

2. `updateInternalNotes` mutation - Updates the internalNotes field only (team use).
   ```typescript
   export const updateInternalNotes = mutation({
     args: {
       id: v.id("submissions"),
       internalNotes: v.string(),
     },
     handler: async (ctx, { id, internalNotes }) => {
       const submission = await ctx.db.get(id);
       if (!submission) {
         throw new Error("Submission not found");
       }

       await ctx.db.patch(id, { internalNotes });
       return await ctx.db.get(id);
     },
   });
   ```

Also update the existing `updateStatus` mutation to accept the 3-step workflow statuses:
- Change validStatuses to: `["pending", "in_review", "quoted", "ordered", "rejected"]`
- "pending" = New, "in_review" = In Review, "quoted" = Quoted (aligns with CONTEXT.md workflow)
  </action>
  <verify>
1. Run `npx convex dev` - should push without errors
2. Run `npm run typecheck` - no TypeScript errors
3. Check Convex dashboard Functions tab shows listAll and updateInternalNotes
  </verify>
  <done>
- listAll query returns all submissions with design data
- updateInternalNotes mutation updates team-only notes
- updateStatus accepts pending/in_review/quoted/ordered/rejected
  </done>
</task>

</tasks>

<verification>
1. Schema deployed: `npx convex dev` completes without errors
2. TypeScript: `npm run typecheck` passes
3. Manual check: Convex dashboard shows new exports in Functions tab
</verification>

<success_criteria>
- internalNotes field exists on submissions table
- listAll query returns all submissions with enriched design data
- updateInternalNotes mutation works for team notes
- updateStatus accepts the 3-step workflow statuses (pending/in_review/quoted)
- All existing submission functionality unchanged (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/06-quote-submission-flow/06-01-SUMMARY.md`
</output>
